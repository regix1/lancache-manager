import{r as i,u as q,j as t,e as $,p as X,U as Q,D as ee,q as te,b as se,s as L,t as ae,S as ce,v as H,w as re,i as z,m as ie}from"./react-vendor-CRal8B6Y.js";import{u as le}from"./index-B5pyjgZ1.js";import{C as R,f as _,a as A,b as ne}from"./Card-BZR4Ifu-.js";import{A as me}from"./Alert-BjJKNMow.js";import"./vendor-BmYUbuLR.js";import"./tanstack-CPlEqbpz.js";function oe({items:n,height:o,itemHeight:d,renderItem:h,overscan:f=5,className:u=""}){const p=i.useRef(null),N=q({count:n.length,getScrollElement:()=>p.current,estimateSize:()=>d,overscan:f});return t.jsx("div",{ref:p,className:`overflow-auto ${u}`,style:{height:`${o}px`},children:t.jsx("div",{style:{height:`${N.getTotalSize()}px`,width:"100%",position:"relative"},children:N.getVirtualItems().map(g=>t.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:`${g.size}px`,transform:`translateY(${g.start}px)`},children:h(n[g.index],g.index)},g.key))})})}const j={SERVICE_FILTER:"lancache_downloads_service",ITEMS_PER_PAGE:"lancache_downloads_items",GROUP_GAMES:"lancache_downloads_group",SHOW_METADATA:"lancache_downloads_metadata",SHOW_SMALL_FILES:"lancache_downloads_show_small"},F=({options:n,value:o,onChange:d,placeholder:h="Select option",className:f=""})=>{const[u,p]=i.useState(!1),N=n.find(l=>l.value===o),g=l=>{d(l),p(!1)};i.useEffect(()=>{const l=C=>{C.target.closest(".custom-dropdown")||p(!1)};if(u)return document.addEventListener("mousedown",l),()=>document.removeEventListener("mousedown",l)},[u]);const v=l=>{l.key==="Enter"||l.key===" "?(l.preventDefault(),p(!u)):l.key==="Escape"&&p(!1)};return t.jsxs("div",{className:`relative custom-dropdown ${f}`,children:[t.jsxs("button",{type:"button",onClick:()=>p(!u),onKeyDown:v,className:"w-full px-3 py-2 themed-input text-themed-primary text-left focus:outline-none hover:bg-themed-hover transition-colors flex items-center justify-between","aria-haspopup":"listbox","aria-expanded":u,children:[t.jsx("span",{className:"truncate",children:N?N.label:h}),t.jsx(ie,{size:16,className:`transition-transform ${u?"rotate-180":""}`})]}),u&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>p(!1)}),t.jsx("div",{className:"mobile-dropdown sm:right-0 themed-card",children:t.jsx("div",{className:"py-1",children:n.map(l=>t.jsx("button",{type:"button",onClick:()=>g(l.value),className:`w-full px-4 py-2 text-left text-sm hover:bg-themed-hover transition-colors ${l.value===o?"bg-themed-hover text-themed-accent":"text-themed-secondary"}`,children:l.label},l.value))})})]})]})},S="lancache_game_info_cache",de=24,B={get:n=>{try{const o=localStorage.getItem(S);if(!o)return null;const d=JSON.parse(o),h=d[n.toString()];return h?Date.now()>h.expiresAt?(delete d[n.toString()],localStorage.setItem(S,JSON.stringify(d)),null):h.data:null}catch(o){return console.error("Error reading game info cache:",o),null}},set:(n,o)=>{try{const d=localStorage.getItem(S),h=d?JSON.parse(d):{},f=Date.now()+de*60*60*1e3;h[n.toString()]={data:o,timestamp:Date.now(),expiresAt:f},localStorage.setItem(S,JSON.stringify(h))}catch(d){console.error("Error saving game info to cache:",d)}},clear:()=>{try{localStorage.removeItem(S)}catch(n){console.error("Error clearing game info cache:",n)}}},je=()=>{const{latestDownloads:n,mockMode:o,updateMockDataCount:d,updateApiDownloadCount:h}=le(),[f,u]=i.useState(null),[p,N]=i.useState(null),[g,v]=i.useState({}),[l,C]=i.useState(null),[I,D]=i.useState(!1),[c,U]=i.useState(()=>({showZeroBytes:localStorage.getItem(j.SHOW_METADATA)==="true",showSmallFiles:localStorage.getItem(j.SHOW_SMALL_FILES)!=="false",selectedService:localStorage.getItem(j.SERVICE_FILTER)||"all",itemsPerPage:(()=>{const e=localStorage.getItem(j.ITEMS_PER_PAGE);return e==="unlimited"?"unlimited":e?parseInt(e,10):20})(),groupGames:localStorage.getItem(j.GROUP_GAMES)==="true"})),b=i.useCallback(e=>{U(s=>({...s,...e}))},[]);i.useEffect(()=>{localStorage.setItem(j.SERVICE_FILTER,c.selectedService),localStorage.setItem(j.ITEMS_PER_PAGE,c.itemsPerPage.toString()),localStorage.setItem(j.GROUP_GAMES,c.groupGames.toString()),localStorage.setItem(j.SHOW_METADATA,c.showZeroBytes.toString()),localStorage.setItem(j.SHOW_SMALL_FILES,c.showSmallFiles.toString())},[c]),i.useEffect(()=>{(()=>{try{const s=localStorage.getItem(S);if(!s)return;const a=JSON.parse(s),r={};let m=!1;Object.entries(a).forEach(([k,x])=>{Date.now()<=x.expiresAt&&(r[parseInt(k)]=x.data,m=!0)}),m&&v(r)}catch(s){console.error("Error loading cached game info:",s)}})()},[]),i.useEffect(()=>{const e=c.itemsPerPage==="unlimited"?100:c.itemsPerPage;o&&d?d(e):!o&&h&&h(e)},[c.itemsPerPage,o,d,h]);const G=i.useMemo(()=>{const e=new Set(n.map(s=>s.service.toLowerCase()));return Array.from(e).sort()},[n]),V=i.useMemo(()=>[{value:"all",label:"All Services"},...G.map(e=>({value:e,label:e.charAt(0).toUpperCase()+e.slice(1)}))],[G]),W=i.useMemo(()=>[{value:"20",label:"20 items"},{value:"50",label:"50 items"},{value:"100",label:"100 items"},{value:"200",label:"200 items"},{value:"unlimited",label:"Load All"}],[]),E=i.useMemo(()=>{let e=[...n];return c.showZeroBytes||(e=e.filter(s=>(s.totalBytes||0)>0)),c.showSmallFiles||(e=e.filter(s=>(s.totalBytes||0)===0||(s.totalBytes||0)>=1048576)),c.selectedService!=="all"&&(e=e.filter(s=>s.service.toLowerCase()===c.selectedService)),e},[n,c]),T=i.useMemo(()=>{if(!c.groupGames)return null;const e={};return E.forEach(s=>{let a,r,m;s.gameName&&s.gameName!=="Unknown Steam Game"?(a=`game-${s.gameName}`,r=s.gameName,m="game"):(s.totalBytes||0)===0?(a=`metadata-${s.service}`,r=`${s.service} Metadata`,m="metadata"):(a=`content-${s.service}`,r=`${s.service} Content`,m="content"),e[a]||(e[a]={id:a,name:r,type:m,service:s.service,downloads:[],totalBytes:0,cacheHitBytes:0,cacheMissBytes:0,clientsSet:new Set,firstSeen:s.startTime,lastSeen:s.endTime||s.startTime,count:0,clientCount:0}),e[a].downloads.push(s),e[a].totalBytes+=s.totalBytes||0,e[a].cacheHitBytes+=s.cacheHitBytes||0,e[a].cacheMissBytes+=s.cacheMissBytes||0,e[a].clientsSet.add(s.clientIp),e[a].count++,new Date(s.startTime)<new Date(e[a].firstSeen)&&(e[a].firstSeen=s.startTime),s.endTime&&new Date(s.endTime)>new Date(e[a].lastSeen)&&(e[a].lastSeen=s.endTime)}),Object.values(e).map(s=>({...s,clientCount:s.clientsSet.size})).sort((s,a)=>a.totalBytes-s.totalBytes)},[E,c.groupGames]),y=i.useMemo(()=>{const e=c.groupGames?T:E;if(!e)return[];if(c.itemsPerPage==="unlimited")return e;const s=typeof c.itemsPerPage=="number"?c.itemsPerPage:50;return e.slice(0,s)},[c.groupGames,c.itemsPerPage,T,E]),J=e=>{const s=e.totalBytes||0,a=e.service.charAt(0).toUpperCase()+e.service.slice(1);return s===0?{type:"metadata",label:e.clientIp==="127.0.0.1"?`${a} Service`:"Metadata",icon:z}:e.service.toLowerCase()==="steam"&&e.gameName&&e.gameName!=="Unknown Steam Game"?{type:"game",label:e.gameName,icon:L}:s<1048576?{type:"metadata",label:`${a} Update`,icon:z}:{type:"content",label:`${a} Content`,icon:H}},M=e=>e>=75?"progress-bar-high":e>=50?"progress-bar-medium":e>=25?"progress-bar-low":"progress-bar-critical",O=e=>"downloads"in e,K=async e=>{if(!(e.service.toLowerCase()!=="steam"||(e.totalBytes||0)===0||!e.id)&&(u(f===e.id?null:e.id),f!==e.id&&!g[e.id])){const s=B.get(e.id);if(s){v(a=>({...a,[e.id]:s}));return}if(o){const a={downloadId:e.id,service:"steam",appId:730,gameName:"Counter-Strike 2",gameType:"game",headerImage:"https://cdn.akamai.steamstatic.com/steam/apps/730/header.jpg",description:"Counter-Strike 2 is a tactical shooter.",totalBytes:e.totalBytes,cacheHitBytes:e.cacheHitBytes,cacheMissBytes:e.cacheMissBytes,cacheHitPercent:e.cacheHitPercent};v(r=>({...r,[e.id]:a})),B.set(e.id,a)}else try{C(e.id);const a=await fetch(`/api/gameinfo/download/${e.id}`);if(a.ok){const r=await a.json();v(m=>({...m,[e.id]:r})),B.set(e.id,r)}}catch(a){console.error("Error fetching game info:",a)}finally{C(null)}}},Z=e=>{N(p===e?null:e)},P=i.useCallback(e=>{const s=p===e.id,a=e.totalBytes>0?e.cacheHitBytes/e.totalBytes*100:0;return t.jsxs(R,{padding:"md",children:[t.jsx("div",{onClick:()=>Z(e.id),className:"cursor-pointer",children:t.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[t.jsxs("div",{className:"col-span-12 sm:col-span-4 md:col-span-3",children:[t.jsx("p",{className:"text-xs text-themed-muted",children:"Group"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx($,{size:16,className:`transition-transform ${s?"rotate-90":""}`}),t.jsx("div",{className:"w-6 h-6 rounded bg-themed-secondary flex items-center justify-center",children:t.jsx(X,{size:14,className:"text-themed-accent"})}),t.jsx("span",{className:"text-sm font-medium text-themed-accent",children:e.name})]}),t.jsxs("p",{className:"text-xs text-themed-muted",children:[e.count," items"]})]}),t.jsxs("div",{className:"col-span-6 sm:col-span-4 md:col-span-3",children:[t.jsx("p",{className:"text-xs text-themed-muted",children:"Size"}),t.jsx("p",{className:"text-sm font-medium",children:e.totalBytes>0?_(e.totalBytes):"Metadata"})]}),t.jsxs("div",{className:"col-span-6 sm:col-span-4 md:col-span-3",children:[t.jsx("p",{className:"text-xs text-themed-muted",children:"Clients"}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Q,{size:14}),t.jsx("span",{className:"text-sm",children:e.clientCount||0})]})]}),t.jsxs("div",{className:"col-span-12 md:col-span-3",children:[t.jsx("p",{className:"text-xs text-themed-muted",children:"Cache Hit"}),e.totalBytes>0?t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"flex-1 progress-track rounded-full h-2 overflow-hidden",children:t.jsx("div",{className:`h-full ${M(a)}`,style:{width:`${a}%`}})}),t.jsx("span",{className:"text-sm",children:A(a)})]}):t.jsx("p",{className:"text-sm text-themed-muted",children:"N/A"})]})]})}),s&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"border-t border-themed-secondary my-4"}),t.jsx("div",{className:"max-h-72 overflow-y-auto",children:t.jsx("div",{className:"space-y-2",children:e.downloads.map(r=>t.jsx("div",{className:"p-2 bg-themed-tertiary rounded",children:t.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[t.jsx("span",{className:"text-xs",children:r.clientIp}),t.jsx("span",{className:"text-xs",children:_(r.totalBytes)}),t.jsx("span",{className:"text-xs",children:A(r.cacheHitPercent||0)}),t.jsx("span",{className:"text-xs",children:ne(r.startTime)})]})},r.id))})})]})]},e.id)},[p]),w=i.useCallback(e=>{const s=f===e.id,a=e.service.toLowerCase()==="steam",r=(e.totalBytes||0)>0,m=J(e),k=m.icon,x=e.id?g[e.id]:void 0;return t.jsx(R,{padding:"md",className:a&&r?"cursor-pointer":"",children:t.jsxs("div",{onClick:()=>a&&r?K(e):void 0,children:[t.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[t.jsxs("div",{className:"col-span-12 sm:col-span-4 md:col-span-3",children:[t.jsx("p",{className:"text-xs text-themed-muted",children:"Service"}),t.jsxs("div",{className:"flex items-center gap-2",children:[a&&r&&t.jsx($,{size:16,className:`transition-transform ${s?"rotate-90":""}`}),t.jsx("span",{className:`text-sm font-medium service-${e.service.toLowerCase()}`,children:e.service}),t.jsx("div",{className:`w-6 h-6 rounded flex items-center justify-center ${m.type==="game"?"download-game":m.type==="metadata"?"download-metadata":"download-content"}`,children:t.jsx(k,{size:14,className:m.type==="game"?"text-themed-primary":m.type==="metadata"?"text-themed-muted":"text-themed-primary"})})]}),m.label&&t.jsx("p",{className:"text-xs text-themed-muted truncate",children:m.label})]}),t.jsxs("div",{className:"col-span-6 sm:col-span-4 md:col-span-2",children:[t.jsx("p",{className:"text-xs text-themed-muted",children:"Client"}),t.jsx("p",{className:"text-sm",children:e.clientIp})]}),t.jsxs("div",{className:"col-span-6 sm:col-span-4 md:col-span-2",children:[t.jsx("p",{className:"text-xs text-themed-muted",children:"Size"}),t.jsx("p",{className:`text-sm ${r?"font-medium":""}`,children:r?_(e.totalBytes):"Metadata"})]}),t.jsxs("div",{className:"col-span-12 sm:col-span-6 md:col-span-3",children:[t.jsx("p",{className:"text-xs text-themed-muted",children:"Cache Hit"}),r?t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"flex-1 progress-track rounded-full h-2 overflow-hidden",children:t.jsx("div",{className:`h-full ${M(e.cacheHitPercent||0)}`,style:{width:`${e.cacheHitPercent||0}%`}})}),t.jsx("span",{className:"text-sm",children:A(e.cacheHitPercent||0)})]}):t.jsx("p",{className:"text-sm text-themed-muted",children:"N/A"})]}),t.jsxs("div",{className:"col-span-12 sm:col-span-6 md:col-span-2",children:[t.jsx("p",{className:"text-xs text-themed-muted",children:"Status"}),e.isActive?t.jsxs("span",{className:"status-active inline-flex items-center gap-1 px-2 py-1 text-xs rounded",children:[t.jsx(ee,{size:12}),"Active"]}):t.jsxs("span",{className:"status-completed inline-flex items-center gap-1 px-2 py-1 text-xs rounded",children:[t.jsx(te,{size:12}),"Done"]})]})]}),s&&x&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"border-t border-themed-secondary my-4"}),l===e.id?t.jsx("div",{className:"flex justify-center py-4",children:t.jsx(se,{className:"w-6 h-6 animate-spin"})}):t.jsxs("div",{className:"flex gap-6 items-start",children:[t.jsx("div",{className:"flex-shrink-0",children:x.headerImage?t.jsx("img",{src:x.headerImage,alt:x.gameName,className:"rounded w-56 object-cover shadow-lg",style:{height:"107px"}}):t.jsx("div",{className:"rounded w-56 flex items-center justify-center shadow-lg",style:{height:"107px",backgroundColor:"var(--theme-bg-tertiary)",border:"1px solid var(--theme-border-primary)"},children:t.jsx(L,{className:"w-12 h-12",style:{color:"var(--theme-text-muted)"}})})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h3",{className:"text-lg font-semibold text-themed-primary mb-3 truncate",children:x.gameName}),x.description&&t.jsx("p",{className:"text-sm text-themed-muted mb-4 line-clamp-3",children:x.description.length>200?`${x.description.substring(0,200)}...`:x.description}),x.appId&&t.jsxs("a",{href:`https://store.steampowered.com/app/${x.appId}`,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 text-sm text-themed-accent hover:text-themed-primary transition-colors font-medium",children:["View on Steam ",t.jsx(ae,{size:16})]})]})]})]})]})},e.id)},[f,g,l]),Y=i.useCallback(e=>O(e)?P(e):w(e),[P,w]);return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-0",children:[t.jsx("h2",{className:"text-xl sm:text-2xl font-semibold text-themed-primary",children:"Downloads"}),t.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(F,{options:V,value:c.selectedService,onChange:e=>b({selectedService:e}),className:"flex-1 sm:min-w-[140px]"}),t.jsx(F,{options:W,value:c.itemsPerPage.toString(),onChange:e=>b({itemsPerPage:e==="unlimited"?"unlimited":parseInt(e)}),className:"flex-1 sm:min-w-[120px]"})]}),t.jsxs("div",{className:"relative flex-shrink-0 self-end sm:self-auto",children:[t.jsx("button",{onClick:()=>D(!I),className:"p-2.5 themed-button-primary transition-colors w-full sm:w-auto",children:t.jsx(ce,{size:20})}),I&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>D(!1)}),t.jsx("div",{className:"mobile-dropdown sm:right-0 themed-card p-4",children:t.jsxs("div",{className:"space-y-3",children:[t.jsx("p",{className:"text-sm font-medium",children:"Settings"}),t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:c.groupGames,onChange:e=>b({groupGames:e.target.checked}),className:"rounded border-themed-secondary"}),t.jsx("span",{className:"text-sm",children:"Group similar items"})]}),t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:c.showZeroBytes,onChange:e=>b({showZeroBytes:e.target.checked}),className:"rounded border-themed-secondary"}),t.jsx("span",{className:"text-sm",children:"Show 0-byte requests"})]}),t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:c.showSmallFiles,onChange:e=>b({showSmallFiles:e.target.checked}),className:"rounded border-themed-secondary"}),t.jsx("span",{className:"text-sm",children:"Show small files"})]})]})})]})]})]})]}),y.length===0&&t.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[t.jsx("div",{className:"w-16 h-16 rounded-full bg-themed-tertiary flex items-center justify-center mb-4",children:t.jsx(H,{size:32,className:"text-themed-muted"})}),t.jsx("p",{className:"text-themed-muted",children:"No downloads found"})]}),y.length>0&&t.jsx(t.Fragment,{children:c.itemsPerPage==="unlimited"&&y.length>100?t.jsx(oe,{items:y,height:window.innerHeight-250,itemHeight:120,renderItem:Y,overscan:3}):t.jsx("div",{className:"space-y-3 max-h-[calc(100vh-250px)] overflow-y-auto custom-scrollbar",children:y.map(e=>O(e)?P(e):w(e))})}),c.itemsPerPage==="unlimited"&&y.length>500&&t.jsxs(me,{color:"yellow",icon:t.jsx(re,{className:"w-5 h-5"}),children:["Loading ",y.length," items. Performance optimized with virtual scrolling."]})]})};export{je as default};
//# sourceMappingURL=DownloadsTab-BAmvlOfO.js.map

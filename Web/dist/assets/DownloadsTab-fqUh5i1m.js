import{r,u as Q,j as t,e as H,p as X,U as ee,b as D,q as M,s as R,i as B,S as te,t as se,v as ae,D as ie,w as re,m as ce}from"./react-vendor-d8C5-Seo.js";import{u as ne}from"./index-BbdyQxYZ.js";import{C as A,f as G,a as F}from"./Card-V7cUvmfc.js";import{A as T}from"./Alert-DbfzQSrM.js";import"./vendor-BmYUbuLR.js";import"./tanstack-CPlEqbpz.js";function le({items:n,height:j,itemHeight:y,renderItem:u,overscan:g=5,className:l=""}){const o=r.useRef(null),p=Q({count:n.length,getScrollElement:()=>o.current,estimateSize:()=>y,overscan:g});return t.jsx("div",{ref:o,className:`overflow-auto ${l}`,style:{height:`${j}px`},children:t.jsx("div",{style:{height:`${p.getTotalSize()}px`,width:"100%",position:"relative"},children:p.getVirtualItems().map(d=>t.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:`${d.size}px`,transform:`translateY(${d.start}px)`},children:u(n[d.index],d.index)},d.key))})})}const x={SERVICE_FILTER:"lancache_downloads_service",ITEMS_PER_PAGE:"lancache_downloads_items",GROUP_GAMES:"lancache_downloads_group",SHOW_METADATA:"lancache_downloads_metadata",SHOW_SMALL_FILES:"lancache_downloads_show_small",HIDE_LOCALHOST:"lancache_downloads_hide_localhost"},me=({src:n,fallback:j,alt:y,className:u="",style:g={},onLoad:l,onError:o})=>{const[p,d]=r.useState(!1),[f,N]=r.useState(!0);r.useEffect(()=>{d(!1),N(!0)},[n]);const S=()=>{N(!1),l==null||l()},c=()=>{d(!0),N(!1),o==null||o()};return!n||p?t.jsx(t.Fragment,{children:j||t.jsx("div",{className:`${u} flex items-center justify-center`,style:{...g,backgroundColor:"var(--theme-bg-tertiary)",border:"1px solid var(--theme-border-primary)"},children:t.jsx(M,{className:"w-12 h-12",style:{color:"var(--theme-text-muted)"}})})}):t.jsxs("div",{className:"relative",children:[f&&t.jsx("div",{className:`${u} flex items-center justify-center absolute inset-0`,style:{...g,backgroundColor:"var(--theme-bg-tertiary)"},children:t.jsx(D,{className:"w-6 h-6 animate-spin"})}),t.jsx("img",{src:n,alt:y,className:u,style:{...g,opacity:f?0:1,transition:"opacity 0.3s"},onLoad:S,onError:c})]})},z=({options:n,value:j,onChange:y,placeholder:u="Select option",className:g=""})=>{const[l,o]=r.useState(!1),p=r.useRef(null),d=r.useRef(null),f=n.find(c=>c.value===j);r.useEffect(()=>{const c=b=>{p.current&&!p.current.contains(b.target)&&d.current&&!d.current.contains(b.target)&&o(!1)},k=b=>{b.key==="Escape"&&o(!1)};if(l)return document.addEventListener("mousedown",c),document.addEventListener("keydown",k),()=>{document.removeEventListener("mousedown",c),document.removeEventListener("keydown",k)}},[l]);const N=c=>{y(c),o(!1)},S=c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),o(!l))};return t.jsxs("div",{className:`relative ${g}`,children:[t.jsxs("button",{ref:d,type:"button",onClick:()=>o(!l),onKeyDown:S,className:"w-full px-3 py-2 themed-input text-themed-primary text-left focus:outline-none hover:bg-themed-hover transition-colors flex items-center justify-between","aria-haspopup":"listbox","aria-expanded":l,children:[t.jsx("span",{className:"truncate",children:f?f.label:u}),t.jsx(ce,{size:16,className:`transition-transform ${l?"rotate-180":""}`})]}),l&&t.jsx("div",{ref:p,className:"absolute mt-1 w-full themed-card shadow-xl border border-themed-border",style:{zIndex:50,maxHeight:"300px",overflowY:"auto"},children:t.jsx("div",{className:"py-1",children:n.map(c=>t.jsx("button",{type:"button",onClick:()=>N(c.value),className:`w-full px-4 py-2 text-left text-sm hover:bg-themed-hover transition-colors ${c.value===j?"bg-themed-hover text-themed-accent":"text-themed-secondary"}`,children:c.label},c.value))})})]})},ge=()=>{const{latestDownloads:n=[],loading:j,mockMode:y,updateMockDataCount:u,updateApiDownloadCount:g}=ne(),[l,o]=r.useState(null),[p,d]=r.useState(null),[f,N]=r.useState({}),[S,c]=r.useState(null),[k,b]=r.useState(!1),[i,E]=r.useState(()=>({showZeroBytes:localStorage.getItem(x.SHOW_METADATA)==="true",showSmallFiles:localStorage.getItem(x.SHOW_SMALL_FILES)!=="false",hideLocalhost:localStorage.getItem(x.HIDE_LOCALHOST)==="true",selectedService:localStorage.getItem(x.SERVICE_FILTER)||"all",groupGames:localStorage.getItem(x.GROUP_GAMES)==="true",itemsPerPage:localStorage.getItem(x.ITEMS_PER_PAGE)==="unlimited"?"unlimited":parseInt(localStorage.getItem(x.ITEMS_PER_PAGE)||"50")})),U=e=>{const s=e.totalBytes||0,a=s===0,m=e.cacheHitBytes||0,h=m>0,C=s>0?m/s*100:0;return a?{type:"metadata",icon:B,iconColor:"text-purple-400",description:"Metadata/Configuration",label:"Metadata"}:C===100?{type:"content",icon:ae,iconColor:"text-green-400",description:"Fully Cached",label:"Cached"}:h?{type:"content",icon:ie,iconColor:"text-yellow-400",description:`${C.toFixed(0)}% Cached`,label:"Partial"}:{type:"content",icon:re,iconColor:"text-gray-400",description:"Not Cached",label:"Uncached"}},V=async e=>{if(!e.id||!e.gameName||e.service.toLowerCase()!=="steam"||f[e.id])return;c(e.id),await new Promise(a=>setTimeout(a,300));const s={downloadId:e.id,service:e.service,appId:e.gameAppId||0,gameName:e.gameName,headerImage:`https://cdn.cloudflare.steamstatic.com/steam/apps/${e.gameAppId}/header.jpg`,description:`${e.gameName} - Downloaded via ${e.service}`,gameType:"game"};N(a=>({...a,[e.id]:s})),c(null)};r.useEffect(()=>{const e=n.filter(a=>a.service.toLowerCase()==="steam"&&a.gameName&&a.gameName!=="Unknown Steam Game"&&a.gameAppId),s={};e.forEach(a=>{a.id&&!f[a.id]&&(s[a.id]={downloadId:a.id,service:a.service,appId:a.gameAppId||0,gameName:a.gameName||"Unknown Game",headerImage:`https://cdn.cloudflare.steamstatic.com/steam/apps/${a.gameAppId}/header.jpg`,description:`${a.gameName} - Downloaded via Steam`,gameType:"game"})}),Object.keys(s).length>0&&N(a=>({...a,...s}))},[n]),r.useEffect(()=>{const e=i.itemsPerPage==="unlimited"?1e4:i.itemsPerPage;y&&u?u(e):!y&&g&&g(e)},[i.itemsPerPage,y,u,g]),r.useEffect(()=>{localStorage.setItem(x.SERVICE_FILTER,i.selectedService),localStorage.setItem(x.ITEMS_PER_PAGE,i.itemsPerPage==="unlimited"?"unlimited":i.itemsPerPage.toString()),localStorage.setItem(x.GROUP_GAMES,i.groupGames.toString()),localStorage.setItem(x.SHOW_METADATA,i.showZeroBytes.toString()),localStorage.setItem(x.SHOW_SMALL_FILES,i.showSmallFiles.toString()),localStorage.setItem(x.HIDE_LOCALHOST,i.hideLocalhost.toString())},[i]);const $=r.useMemo(()=>{const e=new Set(n.map(s=>s.service.toLowerCase()));return Array.from(e).sort()},[n]),W=r.useMemo(()=>[{value:"all",label:"All Services"},...$.map(e=>({value:e,label:e.charAt(0).toUpperCase()+e.slice(1)}))],[$]),Z=r.useMemo(()=>[{value:"20",label:"20 items"},{value:"50",label:"50 items"},{value:"100",label:"100 items"},{value:"200",label:"200 items"},{value:"unlimited",label:"Load All"}],[]),I=r.useMemo(()=>{let e=[...n];return i.showZeroBytes||(e=e.filter(s=>(s.totalBytes||0)>0)),i.showSmallFiles||(e=e.filter(s=>(s.totalBytes||0)===0||(s.totalBytes||0)>=1048576)),i.hideLocalhost&&(e=e.filter(s=>s.clientIp!=="127.0.0.1"&&s.clientIp!=="::1")),i.selectedService!=="all"&&(e=e.filter(s=>s.service.toLowerCase()===i.selectedService)),e},[n,i]),O=r.useMemo(()=>{if(!i.groupGames)return null;const e={};return I.forEach(s=>{let a,m,h;s.gameName&&s.gameName!=="Unknown Steam Game"?(a=`game-${s.gameName}`,m=s.gameName,h="game"):(s.totalBytes||0)===0?(a=`metadata-${s.service}`,m=`${s.service} Metadata`,h="metadata"):(a=`content-${s.service}`,m=`${s.service} Content`,h="content"),e[a]||(e[a]={id:a,name:m,type:h,service:s.service,downloads:[],totalBytes:0,cacheHitBytes:0,cacheMissBytes:0,clientsSet:new Set,firstSeen:s.startTime,lastSeen:s.startTime,count:0}),e[a].downloads.push(s),e[a].totalBytes+=s.totalBytes||0,e[a].cacheHitBytes+=s.cacheHitBytes||0,e[a].cacheMissBytes+=s.cacheMissBytes||0,e[a].clientsSet.add(s.clientIp),e[a].count++,s.startTime<e[a].firstSeen&&(e[a].firstSeen=s.startTime),s.startTime>e[a].lastSeen&&(e[a].lastSeen=s.startTime)}),Object.values(e).sort((s,a)=>s.type==="game"&&a.type!=="game"?-1:s.type!=="game"&&a.type==="game"?1:a.totalBytes-s.totalBytes)},[I,i.groupGames]),w=r.useMemo(()=>{const e=i.groupGames?O||[]:I;if(i.itemsPerPage==="unlimited")return e;const s=typeof i.itemsPerPage=="number"?i.itemsPerPage:50;return e.slice(0,s)},[i.groupGames,i.itemsPerPage,O,I]),K=async e=>{const s=e.service.toLowerCase()==="steam",a=(e.totalBytes||0)>0;if(!(s&&a&&e.gameName&&e.gameName!=="Unknown Steam Game"))return;const h=l===e.id?null:e.id;o(h),h&&!f[e.id]&&await V(e)},Y=e=>{d(p===e?null:e)},P=r.useCallback(e=>{const s=p===e.id,a=e.totalBytes>0?e.cacheHitBytes/e.totalBytes*100:0;return t.jsxs(A,{padding:"sm",children:[t.jsx("div",{onClick:()=>Y(e.id),className:"cursor-pointer",children:t.jsxs("div",{className:"flex items-center justify-between py-1",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(H,{size:16,className:`transition-transform ${s?"rotate-90":""}`}),t.jsx("div",{className:"w-6 h-6 rounded bg-themed-secondary flex items-center justify-center",children:t.jsx(X,{size:14,className:"text-themed-accent"})}),t.jsx("span",{className:"text-sm font-medium text-themed-accent",children:e.name})]}),t.jsxs("span",{className:"text-xs text-themed-muted",children:["(",e.count," items)"]})]}),t.jsx("div",{className:"flex items-center gap-6",children:t.jsxs("div",{className:"text-right",children:[t.jsx("div",{className:"text-sm font-medium text-themed-primary",children:G(e.totalBytes)}),e.totalBytes>0&&t.jsxs("div",{className:"text-xs text-themed-muted",children:[F(a)," cached"]})]})})]})}),s&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"border-t border-themed-secondary my-4"}),t.jsx("div",{className:"max-h-96 overflow-y-auto",children:t.jsx("div",{className:"space-y-1",children:e.downloads.map(m=>t.jsx("div",{className:"p-3 rounded bg-themed-secondary",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("span",{className:`text-xs font-medium service-${m.service.toLowerCase()}`,children:m.service}),t.jsx("span",{className:"text-xs text-themed-muted",children:m.clientIp})]}),t.jsx("div",{className:"text-xs text-themed-muted",children:G(m.totalBytes||0)})]})},m.id))})})]})]},e.id)},[p]),L=r.useCallback(e=>{const s=l===e.id,a=e.service.toLowerCase()==="steam",m=(e.totalBytes||0)>0,h=a&&m&&e.gameName&&e.gameName!=="Unknown Steam Game",C=U(e),J=C.icon,v=e.id?f[e.id]:void 0;return t.jsx(A,{padding:"sm",children:t.jsxs("div",{onClick:()=>h?K(e):void 0,className:h?"cursor-pointer":"",children:[t.jsxs("div",{className:"flex items-center justify-between py-1",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[h&&t.jsx(H,{size:16,className:`transition-transform ${s?"rotate-90":""}`}),t.jsx("span",{className:`text-sm font-medium service-${e.service.toLowerCase()}`,children:e.service})]}),e.gameName&&e.gameName!=="Unknown Steam Game"&&t.jsx("span",{className:"text-sm text-themed-primary font-medium",children:e.gameName}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(J,{size:14,className:C.iconColor}),t.jsx("span",{className:"text-xs text-themed-muted",children:C.description})]})]}),t.jsxs("div",{className:"flex items-center gap-6",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(ee,{size:14,className:"text-themed-muted"}),t.jsx("span",{className:"text-xs text-themed-muted",children:e.clientIp})]}),t.jsxs("div",{className:"text-right",children:[t.jsx("div",{className:"text-sm font-medium text-themed-primary",children:G(e.totalBytes||0)}),e.totalBytes&&e.totalBytes>0&&t.jsxs("div",{className:"text-xs text-themed-muted",children:[F((e.cacheHitBytes||0)/e.totalBytes*100)," hit"]})]})]})]}),s&&h&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"border-t border-themed-secondary my-4"}),S===e.id?t.jsx("div",{className:"flex justify-center py-4",children:t.jsx(D,{className:"w-6 h-6 animate-spin"})}):v?t.jsxs("div",{className:"flex gap-6 items-start",children:[t.jsx("div",{className:"flex-shrink-0",children:t.jsx(me,{src:v.headerImage||"",alt:v.gameName||"Game",className:"rounded shadow-lg",style:{width:"224px",height:"107px",objectFit:"cover"},fallback:t.jsx("div",{className:"rounded flex items-center justify-center shadow-lg",style:{width:"224px",height:"107px",backgroundColor:"var(--theme-bg-tertiary)",border:"1px solid var(--theme-border-primary)"},children:t.jsx(M,{className:"w-12 h-12",style:{color:"var(--theme-text-muted)"}})})})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h3",{className:"text-lg font-semibold text-themed-primary mb-3 truncate",children:v.gameName||"Unknown Game"}),v.description&&t.jsx("p",{className:"text-sm text-themed-secondary mb-4 line-clamp-2",children:v.description}),t.jsx("div",{className:"flex flex-wrap gap-4 text-xs text-themed-muted",children:v.gameType&&t.jsxs("span",{children:["Type: ",v.gameType]})}),a&&t.jsxs("a",{href:`https://store.steampowered.com/app/${v.appId}`,target:"_blank",rel:"noopener noreferrer",onClick:_=>_.stopPropagation(),className:"inline-flex items-center gap-2 mt-4 px-3 py-1 rounded bg-themed-secondary hover:bg-themed-hover transition-colors text-xs text-themed-accent",children:["View on Steam",t.jsx(R,{size:12})]})]})]}):t.jsxs("div",{className:"flex gap-6 items-start",children:[t.jsx("div",{className:"flex-shrink-0",children:t.jsx("div",{className:"rounded flex items-center justify-center shadow-lg",style:{width:"224px",height:"107px",backgroundColor:"var(--theme-bg-tertiary)",border:"1px solid var(--theme-border-primary)"},children:t.jsx(M,{className:"w-12 h-12",style:{color:"var(--theme-text-muted)"}})})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h3",{className:"text-lg font-semibold text-themed-primary mb-3 truncate",children:e.gameName||"Loading..."}),t.jsx("p",{className:"text-sm text-themed-secondary mb-4",children:"Loading game information..."}),a&&e.gameAppId&&t.jsxs("a",{href:`https://store.steampowered.com/app/${e.gameAppId}`,target:"_blank",rel:"noopener noreferrer",onClick:_=>_.stopPropagation(),className:"inline-flex items-center gap-2 mt-4 px-3 py-1 rounded bg-themed-secondary hover:bg-themed-hover transition-colors text-xs text-themed-accent",children:["View on Steam",t.jsx(R,{size:12})]})]})]})]})]})},e.id)},[l,f,S]),q=r.useCallback(e=>"downloads"in e?P(e):L(e),[P,L]);return j?t.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:t.jsx(D,{className:"w-8 h-8 animate-spin"})}):n.length===0?t.jsx(T,{color:"blue",icon:t.jsx(B,{className:"w-5 h-5"}),children:"No downloads recorded yet. Downloads will appear here as clients request content."}):t.jsxs("div",{className:"space-y-4",children:[t.jsxs(A,{padding:"sm",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 items-start sm:items-center flex-1",children:[t.jsx(z,{options:W,value:i.selectedService,onChange:e=>E({...i,selectedService:e}),className:"w-full sm:w-40"}),t.jsx(z,{options:Z,value:i.itemsPerPage==="unlimited"?"unlimited":i.itemsPerPage.toString(),onChange:e=>E({...i,itemsPerPage:e==="unlimited"?"unlimited":parseInt(e)}),className:"w-full sm:w-32"})]}),t.jsx("button",{onClick:()=>b(!k),className:"p-2 rounded hover:bg-themed-hover transition-colors",title:"Settings",children:t.jsx(te,{size:18})})]}),k&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"border-t border-themed-secondary my-3"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:i.groupGames,onChange:e=>E({...i,groupGames:e.target.checked}),className:"themed-checkbox"}),t.jsx("span",{className:"text-sm text-themed-secondary",children:"Group by games"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:i.showZeroBytes,onChange:e=>E({...i,showZeroBytes:e.target.checked}),className:"themed-checkbox"}),t.jsx("span",{className:"text-sm text-themed-secondary",children:"Show metadata (0 bytes)"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:i.showSmallFiles,onChange:e=>E({...i,showSmallFiles:e.target.checked}),className:"themed-checkbox"}),t.jsx("span",{className:"text-sm text-themed-secondary",children:"Show small files (< 1MB)"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:i.hideLocalhost,onChange:e=>E({...i,hideLocalhost:e.target.checked}),className:"themed-checkbox"}),t.jsx("span",{className:"text-sm text-themed-secondary",children:"Hide localhost (127.0.0.1)"})]})]})]})]}),I.length!==n.length&&t.jsxs(T,{color:"blue",icon:t.jsx(B,{className:"w-5 h-5"}),children:["Showing ",I.length," of ",n.length," downloads",i.selectedService!=="all"&&` for ${i.selectedService}`]}),t.jsx("div",{children:i.itemsPerPage==="unlimited"&&w.length>100?t.jsx(le,{items:w,height:window.innerHeight-250,itemHeight:120,renderItem:q}):t.jsx("div",{className:"space-y-3",children:w.map(e=>"downloads"in e?P(e):L(e))})}),i.itemsPerPage==="unlimited"&&w.length>500&&t.jsxs(T,{color:"yellow",icon:t.jsx(se,{className:"w-5 h-5"}),children:["Loading ",w.length," items. Performance optimized with virtual scrolling."]})]})};export{ge as default};
//# sourceMappingURL=DownloadsTab-fqUh5i1m.js.map

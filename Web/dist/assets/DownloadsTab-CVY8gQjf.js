import{r as i,u as Q,j as t,e as O,p as X,U as ee,b as D,q as M,s as F,i as _,S as te,t as se,v as ae,D as re,w as ie,m as ne}from"./react-vendor-CesVvHrP.js";import{u as ce}from"./index-CDhHlmBG.js";import{C as A,f as L,a as z}from"./Card-yRS5xGqS.js";import{A as T}from"./Alert-CK8L5O9K.js";import"./vendor-BmYUbuLR.js";import"./tanstack-CPlEqbpz.js";function le({items:c,height:j,itemHeight:y,renderItem:p,overscan:u=5,className:l=""}){const o=i.useRef(null),x=Q({count:c.length,getScrollElement:()=>o.current,estimateSize:()=>y,overscan:u});return t.jsx("div",{ref:o,className:`overflow-auto ${l}`,style:{height:`${j}px`},children:t.jsx("div",{style:{height:`${x.getTotalSize()}px`,width:"100%",position:"relative"},children:x.getVirtualItems().map(d=>t.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:`${d.size}px`,transform:`translateY(${d.start}px)`},children:p(c[d.index],d.index)},d.key))})})}const f={SERVICE_FILTER:"lancache_downloads_service",ITEMS_PER_PAGE:"lancache_downloads_items",GROUP_GAMES:"lancache_downloads_group",SHOW_METADATA:"lancache_downloads_metadata",SHOW_SMALL_FILES:"lancache_downloads_show_small"},me=({src:c,fallback:j,alt:y,className:p="",style:u={},onLoad:l,onError:o})=>{const[x,d]=i.useState(!1),[g,N]=i.useState(!0);i.useEffect(()=>{d(!1),N(!0)},[c]);const S=()=>{N(!1),l==null||l()},n=()=>{d(!0),N(!1),o==null||o()};return!c||x?t.jsx(t.Fragment,{children:j||t.jsx("div",{className:`${p} flex items-center justify-center`,style:{...u,backgroundColor:"var(--theme-bg-tertiary)",border:"1px solid var(--theme-border-primary)"},children:t.jsx(M,{className:"w-12 h-12",style:{color:"var(--theme-text-muted)"}})})}):t.jsxs("div",{className:"relative",children:[g&&t.jsx("div",{className:`${p} flex items-center justify-center absolute inset-0`,style:{...u,backgroundColor:"var(--theme-bg-tertiary)"},children:t.jsx(D,{className:"w-6 h-6 animate-spin"})}),t.jsx("img",{src:c,alt:y,className:p,style:{...u,opacity:g?0:1,transition:"opacity 0.3s"},onLoad:S,onError:n})]})},H=({options:c,value:j,onChange:y,placeholder:p="Select option",className:u=""})=>{const[l,o]=i.useState(!1),x=i.useRef(null),d=i.useRef(null),g=c.find(n=>n.value===j);i.useEffect(()=>{const n=b=>{x.current&&!x.current.contains(b.target)&&d.current&&!d.current.contains(b.target)&&o(!1)},k=b=>{b.key==="Escape"&&o(!1)};if(l)return document.addEventListener("mousedown",n),document.addEventListener("keydown",k),()=>{document.removeEventListener("mousedown",n),document.removeEventListener("keydown",k)}},[l]);const N=n=>{y(n),o(!1)},S=n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),o(!l))};return t.jsxs("div",{className:`relative ${u}`,children:[t.jsxs("button",{ref:d,type:"button",onClick:()=>o(!l),onKeyDown:S,className:"w-full px-3 py-2 themed-input text-themed-primary text-left focus:outline-none hover:bg-themed-hover transition-colors flex items-center justify-between","aria-haspopup":"listbox","aria-expanded":l,children:[t.jsx("span",{className:"truncate",children:g?g.label:p}),t.jsx(ne,{size:16,className:`transition-transform ${l?"rotate-180":""}`})]}),l&&t.jsx("div",{ref:x,className:"absolute mt-1 w-full themed-card shadow-xl border border-themed-border",style:{zIndex:50,maxHeight:"300px",overflowY:"auto"},children:t.jsx("div",{className:"py-1",children:c.map(n=>t.jsx("button",{type:"button",onClick:()=>N(n.value),className:`w-full px-4 py-2 text-left text-sm hover:bg-themed-hover transition-colors ${n.value===j?"bg-themed-hover text-themed-accent":"text-themed-secondary"}`,children:n.label},n.value))})})]})},ge=()=>{const{latestDownloads:c=[],loading:j,mockMode:y,updateMockDataCount:p,updateApiDownloadCount:u}=ce(),[l,o]=i.useState(null),[x,d]=i.useState(null),[g,N]=i.useState({}),[S,n]=i.useState(null),[k,b]=i.useState(!1),[r,I]=i.useState(()=>({showZeroBytes:localStorage.getItem(f.SHOW_METADATA)==="true",showSmallFiles:localStorage.getItem(f.SHOW_SMALL_FILES)!=="false",selectedService:localStorage.getItem(f.SERVICE_FILTER)||"all",groupGames:localStorage.getItem(f.GROUP_GAMES)==="true",itemsPerPage:localStorage.getItem(f.ITEMS_PER_PAGE)==="unlimited"?"unlimited":parseInt(localStorage.getItem(f.ITEMS_PER_PAGE)||"50")})),U=e=>{const s=e.totalBytes||0,a=s===0,m=e.cacheHitBytes||0,h=m>0,C=s>0?m/s*100:0;return a?{type:"metadata",icon:_,iconColor:"text-purple-400",description:"Metadata/Configuration",label:"Metadata"}:C===100?{type:"content",icon:ae,iconColor:"text-green-400",description:"Fully Cached",label:"Cached"}:h?{type:"content",icon:re,iconColor:"text-yellow-400",description:`${C.toFixed(0)}% Cached`,label:"Partial"}:{type:"content",icon:ie,iconColor:"text-gray-400",description:"Not Cached",label:"Uncached"}},V=async e=>{if(!e.id||!e.gameName||e.service.toLowerCase()!=="steam"||g[e.id])return;n(e.id),await new Promise(a=>setTimeout(a,300));const s={downloadId:e.id,service:e.service,appId:e.gameAppId||0,gameName:e.gameName,headerImage:`https://cdn.cloudflare.steamstatic.com/steam/apps/${e.gameAppId}/header.jpg`,description:`${e.gameName} - Downloaded via ${e.service}`,gameType:"game"};N(a=>({...a,[e.id]:s})),n(null)};i.useEffect(()=>{const e=c.filter(a=>a.service.toLowerCase()==="steam"&&a.gameName&&a.gameName!=="Unknown Steam Game"&&a.gameAppId),s={};e.forEach(a=>{a.id&&!g[a.id]&&(s[a.id]={downloadId:a.id,service:a.service,appId:a.gameAppId||0,gameName:a.gameName||"Unknown Game",headerImage:`https://cdn.cloudflare.steamstatic.com/steam/apps/${a.gameAppId}/header.jpg`,description:`${a.gameName} - Downloaded via Steam`,gameType:"game"})}),Object.keys(s).length>0&&N(a=>({...a,...s}))},[c]),i.useEffect(()=>{const e=r.itemsPerPage==="unlimited"?1e4:r.itemsPerPage;y&&p?p(e):!y&&u&&u(e)},[r.itemsPerPage,y,p,u]),i.useEffect(()=>{localStorage.setItem(f.SERVICE_FILTER,r.selectedService),localStorage.setItem(f.ITEMS_PER_PAGE,r.itemsPerPage==="unlimited"?"unlimited":r.itemsPerPage.toString()),localStorage.setItem(f.GROUP_GAMES,r.groupGames.toString()),localStorage.setItem(f.SHOW_METADATA,r.showZeroBytes.toString()),localStorage.setItem(f.SHOW_SMALL_FILES,r.showSmallFiles.toString())},[r]);const $=i.useMemo(()=>{const e=new Set(c.map(s=>s.service.toLowerCase()));return Array.from(e).sort()},[c]),W=i.useMemo(()=>[{value:"all",label:"All Services"},...$.map(e=>({value:e,label:e.charAt(0).toUpperCase()+e.slice(1)}))],[$]),Z=i.useMemo(()=>[{value:"20",label:"20 items"},{value:"50",label:"50 items"},{value:"100",label:"100 items"},{value:"200",label:"200 items"},{value:"unlimited",label:"Load All"}],[]),E=i.useMemo(()=>{let e=[...c];return r.showZeroBytes||(e=e.filter(s=>(s.totalBytes||0)>0)),r.showSmallFiles||(e=e.filter(s=>(s.totalBytes||0)===0||(s.totalBytes||0)>=1048576)),r.selectedService!=="all"&&(e=e.filter(s=>s.service.toLowerCase()===r.selectedService)),e},[c,r]),R=i.useMemo(()=>{if(!r.groupGames)return null;const e={};return E.forEach(s=>{let a,m,h;s.gameName&&s.gameName!=="Unknown Steam Game"?(a=`game-${s.gameName}`,m=s.gameName,h="game"):(s.totalBytes||0)===0?(a=`metadata-${s.service}`,m=`${s.service} Metadata`,h="metadata"):(a=`content-${s.service}`,m=`${s.service} Content`,h="content"),e[a]||(e[a]={id:a,name:m,type:h,service:s.service,downloads:[],totalBytes:0,cacheHitBytes:0,cacheMissBytes:0,clientsSet:new Set,firstSeen:s.startTime,lastSeen:s.startTime,count:0}),e[a].downloads.push(s),e[a].totalBytes+=s.totalBytes||0,e[a].cacheHitBytes+=s.cacheHitBytes||0,e[a].cacheMissBytes+=s.cacheMissBytes||0,e[a].clientsSet.add(s.clientIp),e[a].count++,s.startTime<e[a].firstSeen&&(e[a].firstSeen=s.startTime),s.startTime>e[a].lastSeen&&(e[a].lastSeen=s.startTime)}),Object.values(e).sort((s,a)=>s.type==="game"&&a.type!=="game"?-1:s.type!=="game"&&a.type==="game"?1:a.totalBytes-s.totalBytes)},[E,r.groupGames]),w=i.useMemo(()=>{const e=r.groupGames?R||[]:E;if(r.itemsPerPage==="unlimited")return e;const s=typeof r.itemsPerPage=="number"?r.itemsPerPage:50;return e.slice(0,s)},[r.groupGames,r.itemsPerPage,R,E]),K=async e=>{const s=e.service.toLowerCase()==="steam",a=(e.totalBytes||0)>0;if(!(s&&a&&e.gameName&&e.gameName!=="Unknown Steam Game"))return;const h=l===e.id?null:e.id;o(h),h&&!g[e.id]&&await V(e)},Y=e=>{d(x===e?null:e)},P=i.useCallback(e=>{const s=x===e.id,a=e.totalBytes>0?e.cacheHitBytes/e.totalBytes*100:0;return t.jsxs(A,{padding:"sm",children:[t.jsx("div",{onClick:()=>Y(e.id),className:"cursor-pointer",children:t.jsxs("div",{className:"flex items-center justify-between py-1",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(O,{size:16,className:`transition-transform ${s?"rotate-90":""}`}),t.jsx("div",{className:"w-6 h-6 rounded bg-themed-secondary flex items-center justify-center",children:t.jsx(X,{size:14,className:"text-themed-accent"})}),t.jsx("span",{className:"text-sm font-medium text-themed-accent",children:e.name})]}),t.jsxs("span",{className:"text-xs text-themed-muted",children:["(",e.count," items)"]})]}),t.jsx("div",{className:"flex items-center gap-6",children:t.jsxs("div",{className:"text-right",children:[t.jsx("div",{className:"text-sm font-medium text-themed-primary",children:L(e.totalBytes)}),e.totalBytes>0&&t.jsxs("div",{className:"text-xs text-themed-muted",children:[z(a)," cached"]})]})})]})}),s&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"border-t border-themed-secondary my-4"}),t.jsx("div",{className:"max-h-96 overflow-y-auto",children:t.jsx("div",{className:"space-y-1",children:e.downloads.map(m=>t.jsx("div",{className:"p-3 rounded bg-themed-secondary",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("span",{className:`text-xs font-medium service-${m.service.toLowerCase()}`,children:m.service}),t.jsx("span",{className:"text-xs text-themed-muted",children:m.clientIp})]}),t.jsx("div",{className:"text-xs text-themed-muted",children:L(m.totalBytes||0)})]})},m.id))})})]})]},e.id)},[x]),B=i.useCallback(e=>{const s=l===e.id,a=e.service.toLowerCase()==="steam",m=(e.totalBytes||0)>0,h=a&&m&&e.gameName&&e.gameName!=="Unknown Steam Game",C=U(e),J=C.icon,v=e.id?g[e.id]:void 0;return t.jsx(A,{padding:"sm",children:t.jsxs("div",{onClick:()=>h?K(e):void 0,className:h?"cursor-pointer":"",children:[t.jsxs("div",{className:"flex items-center justify-between py-1",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[h&&t.jsx(O,{size:16,className:`transition-transform ${s?"rotate-90":""}`}),t.jsx("span",{className:`text-sm font-medium service-${e.service.toLowerCase()}`,children:e.service})]}),e.gameName&&e.gameName!=="Unknown Steam Game"&&t.jsx("span",{className:"text-sm text-themed-primary font-medium",children:e.gameName}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(J,{size:14,className:C.iconColor}),t.jsx("span",{className:"text-xs text-themed-muted",children:C.description})]})]}),t.jsxs("div",{className:"flex items-center gap-6",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(ee,{size:14,className:"text-themed-muted"}),t.jsx("span",{className:"text-xs text-themed-muted",children:e.clientIp})]}),t.jsxs("div",{className:"text-right",children:[t.jsx("div",{className:"text-sm font-medium text-themed-primary",children:L(e.totalBytes||0)}),e.totalBytes&&e.totalBytes>0&&t.jsxs("div",{className:"text-xs text-themed-muted",children:[z((e.cacheHitBytes||0)/e.totalBytes*100)," hit"]})]})]})]}),s&&h&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"border-t border-themed-secondary my-4"}),S===e.id?t.jsx("div",{className:"flex justify-center py-4",children:t.jsx(D,{className:"w-6 h-6 animate-spin"})}):v?t.jsxs("div",{className:"flex gap-6 items-start",children:[t.jsx("div",{className:"flex-shrink-0",children:t.jsx(me,{src:v.headerImage||"",alt:v.gameName||"Game",className:"rounded shadow-lg",style:{width:"224px",height:"107px",objectFit:"cover"},fallback:t.jsx("div",{className:"rounded flex items-center justify-center shadow-lg",style:{width:"224px",height:"107px",backgroundColor:"var(--theme-bg-tertiary)",border:"1px solid var(--theme-border-primary)"},children:t.jsx(M,{className:"w-12 h-12",style:{color:"var(--theme-text-muted)"}})})})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h3",{className:"text-lg font-semibold text-themed-primary mb-3 truncate",children:v.gameName||"Unknown Game"}),v.description&&t.jsx("p",{className:"text-sm text-themed-secondary mb-4 line-clamp-2",children:v.description}),t.jsx("div",{className:"flex flex-wrap gap-4 text-xs text-themed-muted",children:v.gameType&&t.jsxs("span",{children:["Type: ",v.gameType]})}),a&&t.jsxs("a",{href:`https://store.steampowered.com/app/${v.appId}`,target:"_blank",rel:"noopener noreferrer",onClick:G=>G.stopPropagation(),className:"inline-flex items-center gap-2 mt-4 px-3 py-1 rounded bg-themed-secondary hover:bg-themed-hover transition-colors text-xs text-themed-accent",children:["View on Steam",t.jsx(F,{size:12})]})]})]}):t.jsxs("div",{className:"flex gap-6 items-start",children:[t.jsx("div",{className:"flex-shrink-0",children:t.jsx("div",{className:"rounded flex items-center justify-center shadow-lg",style:{width:"224px",height:"107px",backgroundColor:"var(--theme-bg-tertiary)",border:"1px solid var(--theme-border-primary)"},children:t.jsx(M,{className:"w-12 h-12",style:{color:"var(--theme-text-muted)"}})})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h3",{className:"text-lg font-semibold text-themed-primary mb-3 truncate",children:e.gameName||"Loading..."}),t.jsx("p",{className:"text-sm text-themed-secondary mb-4",children:"Loading game information..."}),a&&e.gameAppId&&t.jsxs("a",{href:`https://store.steampowered.com/app/${e.gameAppId}`,target:"_blank",rel:"noopener noreferrer",onClick:G=>G.stopPropagation(),className:"inline-flex items-center gap-2 mt-4 px-3 py-1 rounded bg-themed-secondary hover:bg-themed-hover transition-colors text-xs text-themed-accent",children:["View on Steam",t.jsx(F,{size:12})]})]})]})]})]})},e.id)},[l,g,S]),q=i.useCallback(e=>"downloads"in e?P(e):B(e),[P,B]);return j?t.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:t.jsx(D,{className:"w-8 h-8 animate-spin"})}):c.length===0?t.jsx(T,{color:"blue",icon:t.jsx(_,{className:"w-5 h-5"}),children:"No downloads recorded yet. Downloads will appear here as clients request content."}):t.jsxs("div",{className:"space-y-4",children:[t.jsxs(A,{padding:"sm",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 items-start sm:items-center flex-1",children:[t.jsx(H,{options:W,value:r.selectedService,onChange:e=>I({...r,selectedService:e}),className:"w-full sm:w-40"}),t.jsx(H,{options:Z,value:r.itemsPerPage==="unlimited"?"unlimited":r.itemsPerPage.toString(),onChange:e=>I({...r,itemsPerPage:e==="unlimited"?"unlimited":parseInt(e)}),className:"w-full sm:w-32"})]}),t.jsx("button",{onClick:()=>b(!k),className:"p-2 rounded hover:bg-themed-hover transition-colors",title:"Settings",children:t.jsx(te,{size:18})})]}),k&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"border-t border-themed-secondary my-3"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:r.groupGames,onChange:e=>I({...r,groupGames:e.target.checked}),className:"themed-checkbox"}),t.jsx("span",{className:"text-sm text-themed-secondary",children:"Group by games"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:r.showZeroBytes,onChange:e=>I({...r,showZeroBytes:e.target.checked}),className:"themed-checkbox"}),t.jsx("span",{className:"text-sm text-themed-secondary",children:"Show metadata (0 bytes)"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:r.showSmallFiles,onChange:e=>I({...r,showSmallFiles:e.target.checked}),className:"themed-checkbox"}),t.jsx("span",{className:"text-sm text-themed-secondary",children:"Show small files (< 1MB)"})]})]})]})]}),E.length!==c.length&&t.jsxs(T,{color:"blue",icon:t.jsx(_,{className:"w-5 h-5"}),children:["Showing ",E.length," of ",c.length," downloads",r.selectedService!=="all"&&` for ${r.selectedService}`]}),t.jsx("div",{children:r.itemsPerPage==="unlimited"&&w.length>100?t.jsx(le,{items:w,height:window.innerHeight-250,itemHeight:120,renderItem:q}):t.jsx("div",{className:"space-y-3",children:w.map(e=>"downloads"in e?P(e):B(e))})}),r.itemsPerPage==="unlimited"&&w.length>500&&t.jsxs(T,{color:"yellow",icon:t.jsx(se,{className:"w-5 h-5"}),children:["Loading ",w.length," items. Performance optimized with virtual scrolling."]})]})};export{ge as default};
//# sourceMappingURL=DownloadsTab-CVY8gQjf.js.map

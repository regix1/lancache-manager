import{r as i,u as Y,j as e,e as O,p as q,U as Q,b as $,q as H,s as X,i as D,S as ee,t as te,v as se,D as ae,w as re,x as ie,m as ce}from"./react-vendor-UnPSNabp.js";import{u as ne}from"./index-pY2Lesco.js";import{C as M,f as T,a as F}from"./Card-BeFm8Baj.js";import{A}from"./Alert-huiT2QF3.js";import"./vendor-BmYUbuLR.js";import"./tanstack-CPlEqbpz.js";function le({items:c,height:S,itemHeight:N,renderItem:p,overscan:g=5,className:n=""}){const m=i.useRef(null),h=Y({count:c.length,getScrollElement:()=>m.current,estimateSize:()=>N,overscan:g});return e.jsx("div",{ref:m,className:`overflow-auto ${n}`,style:{height:`${S}px`},children:e.jsx("div",{style:{height:`${h.getTotalSize()}px`,width:"100%",position:"relative"},children:h.getVirtualItems().map(o=>e.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:`${o.size}px`,transform:`translateY(${o.start}px)`},children:p(c[o.index],o.index)},o.key))})})}const j={SERVICE_FILTER:"lancache_downloads_service",ITEMS_PER_PAGE:"lancache_downloads_items",GROUP_GAMES:"lancache_downloads_group",SHOW_METADATA:"lancache_downloads_metadata",SHOW_SMALL_FILES:"lancache_downloads_show_small"},oe=({src:c,fallback:S,alt:N,className:p="",style:g={},onLoad:n,onError:m})=>{const[h,o]=i.useState("loading"),[v,w]=i.useState(null);return i.useEffect(()=>{if(!c){o("error");return}o("loading");const f=new Image;return f.onload=()=>{w(c),o("loaded"),n==null||n()},f.onerror=()=>{o("error"),m==null||m()},f.src=c,()=>{f.onload=null,f.onerror=null}},[c,n,m]),h==="error"||!c?e.jsx(e.Fragment,{children:S||e.jsx("div",{className:`${p} flex items-center justify-center`,style:{...g,backgroundColor:"var(--theme-bg-tertiary)",border:"1px solid var(--theme-border-primary)"},children:e.jsx(H,{className:"w-12 h-12",style:{color:"var(--theme-text-muted)"}})})}):e.jsxs(e.Fragment,{children:[h==="loading"&&e.jsx("div",{className:`${p} flex items-center justify-center`,style:{...g,backgroundColor:"var(--theme-bg-tertiary)"},children:e.jsx($,{className:"w-6 h-6 animate-spin"})}),h==="loaded"&&v&&e.jsx("img",{src:v,alt:N,className:p,style:g})]})},z=({options:c,value:S,onChange:N,placeholder:p="Select option",className:g=""})=>{const[n,m]=i.useState(!1),h=i.useRef(null),o=i.useRef(null),[v,w]=i.useState({top:0,left:0,width:0}),f=c.find(s=>s.value===S);i.useEffect(()=>{if(n&&o.current){const s=o.current.getBoundingClientRect(),y=window.innerHeight-s.bottom,b=s.top,_=y<200&&b>y;w({top:_?s.top-8:s.bottom+8,left:s.left,width:s.width})}},[n]),i.useEffect(()=>{const s=b=>{h.current&&!h.current.contains(b.target)&&o.current&&!o.current.contains(b.target)&&m(!1)},y=b=>{b.key==="Escape"&&m(!1)};if(n)return document.addEventListener("mousedown",s),document.addEventListener("keydown",y),()=>{document.removeEventListener("mousedown",s),document.removeEventListener("keydown",y)}},[n]);const P=s=>{N(s),m(!1)},I=s=>{(s.key==="Enter"||s.key===" ")&&(s.preventDefault(),m(!n))},k=n&&ie.createPortal(e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0",style:{zIndex:9998},onClick:()=>m(!1)}),e.jsx("div",{ref:h,className:"fixed themed-card shadow-xl border border-themed-border",style:{zIndex:9999,top:`${v.top}px`,left:`${v.left}px`,width:`${v.width}px`,maxHeight:"300px",overflowY:"auto"},children:e.jsx("div",{className:"py-1",children:c.map(s=>e.jsx("button",{type:"button",onClick:()=>P(s.value),className:`w-full px-4 py-2 text-left text-sm hover:bg-themed-hover transition-colors ${s.value===S?"bg-themed-hover text-themed-accent":"text-themed-secondary"}`,children:s.label},s.value))})})]}),document.body);return e.jsxs("div",{className:`relative ${g}`,children:[e.jsxs("button",{ref:o,type:"button",onClick:()=>m(!n),onKeyDown:I,className:"w-full px-3 py-2 themed-input text-themed-primary text-left focus:outline-none hover:bg-themed-hover transition-colors flex items-center justify-between","aria-haspopup":"listbox","aria-expanded":n,children:[e.jsx("span",{className:"truncate",children:f?f.label:p}),e.jsx(ce,{size:16,className:`transition-transform ${n?"rotate-180":""}`})]}),k]})},ge=()=>{const{latestDownloads:c=[],loading:S,mockMode:N,updateMockDataCount:p,updateApiDownloadCount:g}=ne(),[n,m]=i.useState(null),[h,o]=i.useState(null),[v,w]=i.useState({}),[f,P]=i.useState(null),[I,k]=i.useState(!1),[s,y]=i.useState(()=>({showZeroBytes:localStorage.getItem(j.SHOW_METADATA)==="true",showSmallFiles:localStorage.getItem(j.SHOW_SMALL_FILES)!=="false",selectedService:localStorage.getItem(j.SERVICE_FILTER)||"all",groupGames:localStorage.getItem(j.GROUP_GAMES)==="true",itemsPerPage:localStorage.getItem(j.ITEMS_PER_PAGE)==="unlimited"?"unlimited":parseInt(localStorage.getItem(j.ITEMS_PER_PAGE)||"50")})),b=t=>{const a=t.totalBytes||0,r=a===0,l=t.cacheHitBytes||0,d=l>0,x=a>0?l/a*100:0;return r?{type:"metadata",icon:D,iconColor:"text-purple-400",description:"Metadata/Configuration",label:"Metadata"}:x===100?{type:"content",icon:se,iconColor:"text-green-400",description:"Fully Cached",label:"Cached"}:d?{type:"content",icon:ae,iconColor:"text-yellow-400",description:`${x.toFixed(0)}% Cached`,label:"Partial"}:{type:"content",icon:re,iconColor:"text-gray-400",description:"Not Cached",label:"Uncached"}},_=async t=>{if(!(!t.id||!t.gameName||t.service.toLowerCase()!=="steam")&&!v[t.id]){P(t.id);try{const a=await fetch(`/api/steam/game/${encodeURIComponent(t.gameName)}`);if(a.ok){const r=await a.json();w(x=>({...x,[t.id]:r}));const l=localStorage.getItem("steam_game_cache")||"{}",d=JSON.parse(l);d[t.gameName]={data:r,timestamp:Date.now()},localStorage.setItem("steam_game_cache",JSON.stringify(d))}}catch(a){console.error("Failed to fetch game info:",a)}finally{P(null)}}};i.useEffect(()=>{(()=>{const a=localStorage.getItem("steam_game_cache");if(a)try{const r=JSON.parse(a),l=Date.now(),d={};c.forEach(x=>{if(x.id&&x.gameName&&r[x.gameName]){const u=r[x.gameName];l-u.timestamp<864e5&&(d[x.id]=u.data)}}),w(d)}catch(r){console.error("Failed to load cached game info:",r)}})()},[c]),i.useEffect(()=>{const t=s.itemsPerPage==="unlimited"?1e4:s.itemsPerPage;N&&p?p(t):!N&&g&&g(t)},[s.itemsPerPage,N,p,g]),i.useEffect(()=>{localStorage.setItem(j.SERVICE_FILTER,s.selectedService),localStorage.setItem(j.ITEMS_PER_PAGE,s.itemsPerPage==="unlimited"?"unlimited":s.itemsPerPage.toString()),localStorage.setItem(j.GROUP_GAMES,s.groupGames.toString()),localStorage.setItem(j.SHOW_METADATA,s.showZeroBytes.toString()),localStorage.setItem(j.SHOW_SMALL_FILES,s.showSmallFiles.toString())},[s]);const L=i.useMemo(()=>{const t=new Set(c.map(a=>a.service.toLowerCase()));return Array.from(t).sort()},[c]),U=i.useMemo(()=>[{value:"all",label:"All Services"},...L.map(t=>({value:t,label:t.charAt(0).toUpperCase()+t.slice(1)}))],[L]),V=i.useMemo(()=>[{value:"20",label:"20 items"},{value:"50",label:"50 items"},{value:"100",label:"100 items"},{value:"200",label:"200 items"},{value:"unlimited",label:"Load All"}],[]),C=i.useMemo(()=>{let t=[...c];return s.showZeroBytes||(t=t.filter(a=>(a.totalBytes||0)>0)),s.showSmallFiles||(t=t.filter(a=>(a.totalBytes||0)===0||(a.totalBytes||0)>=1048576)),s.selectedService!=="all"&&(t=t.filter(a=>a.service.toLowerCase()===s.selectedService)),t},[c,s]),R=i.useMemo(()=>{if(!s.groupGames)return null;const t={};return C.forEach(a=>{let r,l,d;a.gameName&&a.gameName!=="Unknown Steam Game"?(r=`game-${a.gameName}`,l=a.gameName,d="game"):(a.totalBytes||0)===0?(r=`metadata-${a.service}`,l=`${a.service} Metadata`,d="metadata"):(r=`content-${a.service}`,l=`${a.service} Content`,d="content"),t[r]||(t[r]={id:r,name:l,type:d,service:a.service,downloads:[],totalBytes:0,cacheHitBytes:0,cacheMissBytes:0,clientsSet:new Set,firstSeen:a.startTime,lastSeen:a.startTime,count:0}),t[r].downloads.push(a),t[r].totalBytes+=a.totalBytes||0,t[r].cacheHitBytes+=a.cacheHitBytes||0,t[r].cacheMissBytes+=a.cacheMissBytes||0,t[r].clientsSet.add(a.clientIp),t[r].count++,a.startTime<t[r].firstSeen&&(t[r].firstSeen=a.startTime),a.startTime>t[r].lastSeen&&(t[r].lastSeen=a.startTime)}),Object.values(t).sort((a,r)=>a.type==="game"&&r.type!=="game"?-1:a.type!=="game"&&r.type==="game"?1:r.totalBytes-a.totalBytes)},[C,s.groupGames]),E=i.useMemo(()=>{const t=s.groupGames?R||[]:C;if(s.itemsPerPage==="unlimited")return t;const a=typeof s.itemsPerPage=="number"?s.itemsPerPage:50;return t.slice(0,a)},[s.groupGames,s.itemsPerPage,R,C]),W=async t=>{if(t.totalBytes===0)return;const a=n===t.id?null:t.id;m(a),a&&t.service.toLowerCase()==="steam"&&t.gameName&&await _(t)},Z=t=>{o(h===t?null:t)},B=i.useCallback(t=>{const a=h===t.id,r=t.totalBytes>0?t.cacheHitBytes/t.totalBytes*100:0;return e.jsxs(M,{padding:"md",children:[e.jsx("div",{onClick:()=>Z(t.id),className:"cursor-pointer",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{size:16,className:`transition-transform ${a?"rotate-90":""}`}),e.jsx("div",{className:"w-6 h-6 rounded bg-themed-secondary flex items-center justify-center",children:e.jsx(q,{size:14,className:"text-themed-accent"})}),e.jsx("span",{className:"text-sm font-medium text-themed-accent",children:t.name})]}),e.jsxs("span",{className:"text-xs text-themed-muted",children:["(",t.count," items)"]})]}),e.jsx("div",{className:"flex items-center gap-6",children:e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm font-medium text-themed-primary",children:T(t.totalBytes)}),t.totalBytes>0&&e.jsxs("div",{className:"text-xs text-themed-muted",children:[F(r)," cached"]})]})})]})}),a&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-themed-secondary my-4"}),e.jsx("div",{className:"max-h-72 overflow-y-auto",children:e.jsx("div",{className:"space-y-2",children:t.downloads.map(l=>e.jsx("div",{className:"p-3 rounded bg-themed-secondary",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:`text-xs font-medium service-${l.service.toLowerCase()}`,children:l.service}),e.jsx("span",{className:"text-xs text-themed-muted",children:l.clientIp})]}),e.jsx("div",{className:"text-xs text-themed-muted",children:T(l.totalBytes||0)})]})},l.id))})})]})]},t.id)},[h]),G=i.useCallback(t=>{const a=n===t.id,r=t.service.toLowerCase()==="steam",l=(t.totalBytes||0)>0,d=b(t),x=d.icon,u=t.id?v[t.id]:void 0;return e.jsx(M,{padding:"md",children:e.jsxs("div",{onClick:()=>W(t),className:l?"cursor-pointer":"",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[l&&e.jsx(O,{size:16,className:`transition-transform ${a?"rotate-90":""}`}),e.jsx("span",{className:`text-sm font-medium service-${t.service.toLowerCase()}`,children:t.service})]}),t.gameName&&t.gameName!=="Unknown Steam Game"&&e.jsx("span",{className:"text-sm text-themed-primary font-medium",children:t.gameName}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{size:14,className:d.iconColor}),e.jsx("span",{className:"text-xs text-themed-muted",children:d.description})]})]}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{size:14,className:"text-themed-muted"}),e.jsx("span",{className:"text-xs text-themed-muted",children:t.clientIp})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm font-medium text-themed-primary",children:T(t.totalBytes||0)}),t.totalBytes&&t.totalBytes>0&&e.jsxs("div",{className:"text-xs text-themed-muted",children:[F((t.cacheHitBytes||0)/t.totalBytes*100)," hit"]})]})]})]}),a&&u&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-themed-secondary my-4"}),f===t.id?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx($,{className:"w-6 h-6 animate-spin"})}):e.jsxs("div",{className:"flex gap-6 items-start",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(oe,{src:u.headerImage||"",alt:u.gameName||"Game",className:"rounded w-56 object-cover shadow-lg",style:{height:"107px"},fallback:e.jsx("div",{className:"rounded w-56 flex items-center justify-center shadow-lg",style:{height:"107px",backgroundColor:"var(--theme-bg-tertiary)",border:"1px solid var(--theme-border-primary)"},children:e.jsx(H,{className:"w-12 h-12",style:{color:"var(--theme-text-muted)"}})})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-lg font-semibold text-themed-primary mb-3 truncate",children:u.gameName||"Unknown Game"}),u.description&&e.jsx("p",{className:"text-sm text-themed-secondary mb-4 line-clamp-2",children:u.description}),e.jsx("div",{className:"flex flex-wrap gap-4 text-xs text-themed-muted",children:u.gameType&&e.jsxs("span",{children:["Type: ",u.gameType]})}),r&&e.jsxs("a",{href:`https://store.steampowered.com/app/${u.appId}`,target:"_blank",rel:"noopener noreferrer",onClick:J=>J.stopPropagation(),className:"inline-flex items-center gap-2 mt-4 px-3 py-1 rounded bg-themed-secondary hover:bg-themed-hover transition-colors text-xs text-themed-accent",children:["View on Steam",e.jsx(X,{size:12})]})]})]})]})]})},t.id)},[n,v,f]),K=i.useCallback(t=>"downloads"in t?B(t):G(t),[B,G]);return S?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsx($,{className:"w-8 h-8 animate-spin"})}):c.length===0?e.jsx(A,{color:"blue",icon:e.jsx(D,{className:"w-5 h-5"}),children:"No downloads recorded yet. Downloads will appear here as clients request content."}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs(M,{padding:"sm",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 items-start sm:items-center flex-1",children:[e.jsx(z,{options:U,value:s.selectedService,onChange:t=>y({...s,selectedService:t}),className:"w-full sm:w-40"}),e.jsx(z,{options:V,value:s.itemsPerPage==="unlimited"?"unlimited":s.itemsPerPage.toString(),onChange:t=>y({...s,itemsPerPage:t==="unlimited"?"unlimited":parseInt(t)}),className:"w-full sm:w-32"})]}),e.jsx("button",{onClick:()=>k(!I),className:"p-2 rounded hover:bg-themed-hover transition-colors",title:"Settings",children:e.jsx(ee,{size:18})})]}),I&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-themed-secondary my-3"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:s.groupGames,onChange:t=>y({...s,groupGames:t.target.checked}),className:"themed-checkbox"}),e.jsx("span",{className:"text-sm text-themed-secondary",children:"Group by games"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:s.showZeroBytes,onChange:t=>y({...s,showZeroBytes:t.target.checked}),className:"themed-checkbox"}),e.jsx("span",{className:"text-sm text-themed-secondary",children:"Show metadata (0 bytes)"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:s.showSmallFiles,onChange:t=>y({...s,showSmallFiles:t.target.checked}),className:"themed-checkbox"}),e.jsx("span",{className:"text-sm text-themed-secondary",children:"Show small files (< 1MB)"})]})]})]})]}),C.length!==c.length&&e.jsxs(A,{color:"blue",icon:e.jsx(D,{className:"w-5 h-5"}),children:["Showing ",C.length," of ",c.length," downloads",s.selectedService!=="all"&&` for ${s.selectedService}`]}),e.jsx("div",{className:"space-y-2",children:s.itemsPerPage==="unlimited"&&E.length>100?e.jsx(le,{items:E,height:window.innerHeight-250,itemHeight:120,renderItem:K}):E.map(t=>"downloads"in t?B(t):G(t))}),s.itemsPerPage==="unlimited"&&E.length>500&&e.jsxs(A,{color:"yellow",icon:e.jsx(te,{className:"w-5 h-5"}),children:["Loading ",E.length," items. Performance optimized with virtual scrolling."]})]})};export{ge as default};
//# sourceMappingURL=DownloadsTab-D-tbLd92.js.map

import{r as i,u as Y,j as e,e as O,p as q,U as Q,b as D,q as F,s as X,i as B,S as ee,t as te,v as se,D as ae,w as re,m as ie}from"./react-vendor-LpjEarnW.js";import{u as ce}from"./index-CXPP-Msr.js";import{C as G,f as L,a as R}from"./Card-vPWNGdfI.js";import{A as T}from"./Alert-CMXzdTu4.js";import"./vendor-BmYUbuLR.js";import"./tanstack-CPlEqbpz.js";function ne({items:l,height:N,itemHeight:j,renderItem:g,overscan:f=5,className:m=""}){const d=i.useRef(null),x=Y({count:l.length,getScrollElement:()=>d.current,estimateSize:()=>j,overscan:f});return e.jsx("div",{ref:d,className:`overflow-auto ${m}`,style:{height:`${N}px`},children:e.jsx("div",{style:{height:`${x.getTotalSize()}px`,width:"100%",position:"relative"},children:x.getVirtualItems().map(h=>e.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:`${h.size}px`,transform:`translateY(${h.start}px)`},children:g(l[h.index],h.index)},h.key))})})}const y={SERVICE_FILTER:"lancache_downloads_service",ITEMS_PER_PAGE:"lancache_downloads_items",GROUP_GAMES:"lancache_downloads_group",SHOW_METADATA:"lancache_downloads_metadata",SHOW_SMALL_FILES:"lancache_downloads_show_small"},le=({src:l,fallback:N,alt:j,className:g="",style:f={},onLoad:m,onError:d})=>{const[x,h]=i.useState(!1),[v,S]=i.useState(!0);i.useEffect(()=>{h(!1),S(!0)},[l]);const b=()=>{S(!1),m==null||m()},c=()=>{h(!0),S(!1),d==null||d()};return!l||x?e.jsx(e.Fragment,{children:N||e.jsx("div",{className:`${g} flex items-center justify-center`,style:{...f,backgroundColor:"var(--theme-bg-tertiary)",border:"1px solid var(--theme-border-primary)"},children:e.jsx(F,{className:"w-12 h-12",style:{color:"var(--theme-text-muted)"}})})}):e.jsxs("div",{className:"relative",children:[v&&e.jsx("div",{className:`${g} flex items-center justify-center absolute inset-0`,style:{...f,backgroundColor:"var(--theme-bg-tertiary)"},children:e.jsx(D,{className:"w-6 h-6 animate-spin"})}),e.jsx("img",{src:l,alt:j,className:g,style:{...f,opacity:v?0:1,transition:"opacity 0.3s"},onLoad:b,onError:c})]})},$=({options:l,value:N,onChange:j,placeholder:g="Select option",className:f=""})=>{const[m,d]=i.useState(!1),x=i.useRef(null),h=i.useRef(null),v=l.find(c=>c.value===N);i.useEffect(()=>{const c=E=>{x.current&&!x.current.contains(E.target)&&h.current&&!h.current.contains(E.target)&&d(!1)},w=E=>{E.key==="Escape"&&d(!1)};if(m)return document.addEventListener("mousedown",c),document.addEventListener("keydown",w),()=>{document.removeEventListener("mousedown",c),document.removeEventListener("keydown",w)}},[m]);const S=c=>{j(c),d(!1)},b=c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),d(!m))};return e.jsxs("div",{className:`relative ${f}`,children:[e.jsxs("button",{ref:h,type:"button",onClick:()=>d(!m),onKeyDown:b,className:"w-full px-3 py-2 themed-input text-themed-primary text-left focus:outline-none hover:bg-themed-hover transition-colors flex items-center justify-between","aria-haspopup":"listbox","aria-expanded":m,children:[e.jsx("span",{className:"truncate",children:v?v.label:g}),e.jsx(ie,{size:16,className:`transition-transform ${m?"rotate-180":""}`})]}),m&&e.jsx("div",{ref:x,className:"absolute mt-1 w-full themed-card shadow-xl border border-themed-border",style:{zIndex:50,maxHeight:"300px",overflowY:"auto"},children:e.jsx("div",{className:"py-1",children:l.map(c=>e.jsx("button",{type:"button",onClick:()=>S(c.value),className:`w-full px-4 py-2 text-left text-sm hover:bg-themed-hover transition-colors ${c.value===N?"bg-themed-hover text-themed-accent":"text-themed-secondary"}`,children:c.label},c.value))})})]})},pe=()=>{const{latestDownloads:l=[],loading:N,mockMode:j,updateMockDataCount:g,updateApiDownloadCount:f}=ce(),[m,d]=i.useState(null),[x,h]=i.useState(null),[v,S]=i.useState({}),[b,c]=i.useState(null),[w,E]=i.useState(!1),[a,P]=i.useState(()=>({showZeroBytes:localStorage.getItem(y.SHOW_METADATA)==="true",showSmallFiles:localStorage.getItem(y.SHOW_SMALL_FILES)!=="false",selectedService:localStorage.getItem(y.SERVICE_FILTER)||"all",groupGames:localStorage.getItem(y.GROUP_GAMES)==="true",itemsPerPage:localStorage.getItem(y.ITEMS_PER_PAGE)==="unlimited"?"unlimited":parseInt(localStorage.getItem(y.ITEMS_PER_PAGE)||"50")})),z=t=>{const s=t.totalBytes||0,r=s===0,n=t.cacheHitBytes||0,o=n>0,u=s>0?n/s*100:0;return r?{type:"metadata",icon:B,iconColor:"text-purple-400",description:"Metadata/Configuration",label:"Metadata"}:u===100?{type:"content",icon:se,iconColor:"text-green-400",description:"Fully Cached",label:"Cached"}:o?{type:"content",icon:ae,iconColor:"text-yellow-400",description:`${u.toFixed(0)}% Cached`,label:"Partial"}:{type:"content",icon:re,iconColor:"text-gray-400",description:"Not Cached",label:"Uncached"}},H=async t=>{if(!(!t.id||!t.gameName||t.service.toLowerCase()!=="steam")&&!v[t.id]){c(t.id);try{const s=await fetch(`/api/steam/game/${encodeURIComponent(t.gameName)}`);if(s.ok){const r=await s.json();S(u=>({...u,[t.id]:r}));const n=localStorage.getItem("steam_game_cache")||"{}",o=JSON.parse(n);o[t.gameName]={data:r,timestamp:Date.now()},localStorage.setItem("steam_game_cache",JSON.stringify(o))}}catch(s){console.error("Failed to fetch game info:",s)}finally{c(null)}}};i.useEffect(()=>{(()=>{const s=localStorage.getItem("steam_game_cache");if(s)try{const r=JSON.parse(s),n=Date.now(),o={};l.forEach(u=>{if(u.id&&u.gameName&&r[u.gameName]){const p=r[u.gameName];n-p.timestamp<864e5&&(o[u.id]=p.data)}}),S(o)}catch(r){console.error("Failed to load cached game info:",r)}})()},[l]),i.useEffect(()=>{const t=a.itemsPerPage==="unlimited"?1e4:a.itemsPerPage;j&&g?g(t):!j&&f&&f(t)},[a.itemsPerPage,j,g,f]),i.useEffect(()=>{localStorage.setItem(y.SERVICE_FILTER,a.selectedService),localStorage.setItem(y.ITEMS_PER_PAGE,a.itemsPerPage==="unlimited"?"unlimited":a.itemsPerPage.toString()),localStorage.setItem(y.GROUP_GAMES,a.groupGames.toString()),localStorage.setItem(y.SHOW_METADATA,a.showZeroBytes.toString()),localStorage.setItem(y.SHOW_SMALL_FILES,a.showSmallFiles.toString())},[a]);const M=i.useMemo(()=>{const t=new Set(l.map(s=>s.service.toLowerCase()));return Array.from(t).sort()},[l]),U=i.useMemo(()=>[{value:"all",label:"All Services"},...M.map(t=>({value:t,label:t.charAt(0).toUpperCase()+t.slice(1)}))],[M]),V=i.useMemo(()=>[{value:"20",label:"20 items"},{value:"50",label:"50 items"},{value:"100",label:"100 items"},{value:"200",label:"200 items"},{value:"unlimited",label:"Load All"}],[]),C=i.useMemo(()=>{let t=[...l];return a.showZeroBytes||(t=t.filter(s=>(s.totalBytes||0)>0)),a.showSmallFiles||(t=t.filter(s=>(s.totalBytes||0)===0||(s.totalBytes||0)>=1048576)),a.selectedService!=="all"&&(t=t.filter(s=>s.service.toLowerCase()===a.selectedService)),t},[l,a]),A=i.useMemo(()=>{if(!a.groupGames)return null;const t={};return C.forEach(s=>{let r,n,o;s.gameName&&s.gameName!=="Unknown Steam Game"?(r=`game-${s.gameName}`,n=s.gameName,o="game"):(s.totalBytes||0)===0?(r=`metadata-${s.service}`,n=`${s.service} Metadata`,o="metadata"):(r=`content-${s.service}`,n=`${s.service} Content`,o="content"),t[r]||(t[r]={id:r,name:n,type:o,service:s.service,downloads:[],totalBytes:0,cacheHitBytes:0,cacheMissBytes:0,clientsSet:new Set,firstSeen:s.startTime,lastSeen:s.startTime,count:0}),t[r].downloads.push(s),t[r].totalBytes+=s.totalBytes||0,t[r].cacheHitBytes+=s.cacheHitBytes||0,t[r].cacheMissBytes+=s.cacheMissBytes||0,t[r].clientsSet.add(s.clientIp),t[r].count++,s.startTime<t[r].firstSeen&&(t[r].firstSeen=s.startTime),s.startTime>t[r].lastSeen&&(t[r].lastSeen=s.startTime)}),Object.values(t).sort((s,r)=>s.type==="game"&&r.type!=="game"?-1:s.type!=="game"&&r.type==="game"?1:r.totalBytes-s.totalBytes)},[C,a.groupGames]),k=i.useMemo(()=>{const t=a.groupGames?A||[]:C;if(a.itemsPerPage==="unlimited")return t;const s=typeof a.itemsPerPage=="number"?a.itemsPerPage:50;return t.slice(0,s)},[a.groupGames,a.itemsPerPage,A,C]),W=async t=>{if(t.totalBytes===0)return;const s=m===t.id?null:t.id;d(s),s&&t.service.toLowerCase()==="steam"&&t.gameName&&await H(t)},Z=t=>{h(x===t?null:t)},I=i.useCallback(t=>{const s=x===t.id,r=t.totalBytes>0?t.cacheHitBytes/t.totalBytes*100:0;return e.jsxs(G,{padding:"sm",children:[e.jsx("div",{onClick:()=>Z(t.id),className:"cursor-pointer",children:e.jsxs("div",{className:"flex items-center justify-between py-1",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{size:16,className:`transition-transform ${s?"rotate-90":""}`}),e.jsx("div",{className:"w-6 h-6 rounded bg-themed-secondary flex items-center justify-center",children:e.jsx(q,{size:14,className:"text-themed-accent"})}),e.jsx("span",{className:"text-sm font-medium text-themed-accent",children:t.name})]}),e.jsxs("span",{className:"text-xs text-themed-muted",children:["(",t.count," items)"]})]}),e.jsx("div",{className:"flex items-center gap-6",children:e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm font-medium text-themed-primary",children:L(t.totalBytes)}),t.totalBytes>0&&e.jsxs("div",{className:"text-xs text-themed-muted",children:[R(r)," cached"]})]})})]})}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-themed-secondary my-4"}),e.jsx("div",{className:"max-h-96 overflow-y-auto",children:e.jsx("div",{className:"space-y-1",children:t.downloads.map(n=>e.jsx("div",{className:"p-3 rounded bg-themed-secondary",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:`text-xs font-medium service-${n.service.toLowerCase()}`,children:n.service}),e.jsx("span",{className:"text-xs text-themed-muted",children:n.clientIp})]}),e.jsx("div",{className:"text-xs text-themed-muted",children:L(n.totalBytes||0)})]})},n.id))})})]})]},t.id)},[x]),_=i.useCallback(t=>{const s=m===t.id,r=t.service.toLowerCase()==="steam",n=(t.totalBytes||0)>0,o=z(t),u=o.icon,p=t.id?v[t.id]:void 0;return e.jsx(G,{padding:"sm",children:e.jsxs("div",{onClick:()=>W(t),className:n?"cursor-pointer":"",children:[e.jsxs("div",{className:"flex items-center justify-between py-1",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[n&&e.jsx(O,{size:16,className:`transition-transform ${s?"rotate-90":""}`}),e.jsx("span",{className:`text-sm font-medium service-${t.service.toLowerCase()}`,children:t.service})]}),t.gameName&&t.gameName!=="Unknown Steam Game"&&e.jsx("span",{className:"text-sm text-themed-primary font-medium",children:t.gameName}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{size:14,className:o.iconColor}),e.jsx("span",{className:"text-xs text-themed-muted",children:o.description})]})]}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{size:14,className:"text-themed-muted"}),e.jsx("span",{className:"text-xs text-themed-muted",children:t.clientIp})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm font-medium text-themed-primary",children:L(t.totalBytes||0)}),t.totalBytes&&t.totalBytes>0&&e.jsxs("div",{className:"text-xs text-themed-muted",children:[R((t.cacheHitBytes||0)/t.totalBytes*100)," hit"]})]})]})]}),s&&p&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-themed-secondary my-4"}),b===t.id?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(D,{className:"w-6 h-6 animate-spin"})}):e.jsxs("div",{className:"flex gap-6 items-start",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(le,{src:p.headerImage||"",alt:p.gameName||"Game",className:"rounded shadow-lg",style:{width:"224px",height:"107px",objectFit:"cover"},fallback:e.jsx("div",{className:"rounded flex items-center justify-center shadow-lg",style:{width:"224px",height:"107px",backgroundColor:"var(--theme-bg-tertiary)",border:"1px solid var(--theme-border-primary)"},children:e.jsx(F,{className:"w-12 h-12",style:{color:"var(--theme-text-muted)"}})})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-lg font-semibold text-themed-primary mb-3 truncate",children:p.gameName||"Unknown Game"}),p.description&&e.jsx("p",{className:"text-sm text-themed-secondary mb-4 line-clamp-2",children:p.description}),e.jsx("div",{className:"flex flex-wrap gap-4 text-xs text-themed-muted",children:p.gameType&&e.jsxs("span",{children:["Type: ",p.gameType]})}),r&&e.jsxs("a",{href:`https://store.steampowered.com/app/${p.appId}`,target:"_blank",rel:"noopener noreferrer",onClick:J=>J.stopPropagation(),className:"inline-flex items-center gap-2 mt-4 px-3 py-1 rounded bg-themed-secondary hover:bg-themed-hover transition-colors text-xs text-themed-accent",children:["View on Steam",e.jsx(X,{size:12})]})]})]})]})]})},t.id)},[m,v,b]),K=i.useCallback(t=>"downloads"in t?I(t):_(t),[I,_]);return N?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsx(D,{className:"w-8 h-8 animate-spin"})}):l.length===0?e.jsx(T,{color:"blue",icon:e.jsx(B,{className:"w-5 h-5"}),children:"No downloads recorded yet. Downloads will appear here as clients request content."}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs(G,{padding:"sm",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 items-start sm:items-center flex-1",children:[e.jsx($,{options:U,value:a.selectedService,onChange:t=>P({...a,selectedService:t}),className:"w-full sm:w-40"}),e.jsx($,{options:V,value:a.itemsPerPage==="unlimited"?"unlimited":a.itemsPerPage.toString(),onChange:t=>P({...a,itemsPerPage:t==="unlimited"?"unlimited":parseInt(t)}),className:"w-full sm:w-32"})]}),e.jsx("button",{onClick:()=>E(!w),className:"p-2 rounded hover:bg-themed-hover transition-colors",title:"Settings",children:e.jsx(ee,{size:18})})]}),w&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-themed-secondary my-3"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:a.groupGames,onChange:t=>P({...a,groupGames:t.target.checked}),className:"themed-checkbox"}),e.jsx("span",{className:"text-sm text-themed-secondary",children:"Group by games"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:a.showZeroBytes,onChange:t=>P({...a,showZeroBytes:t.target.checked}),className:"themed-checkbox"}),e.jsx("span",{className:"text-sm text-themed-secondary",children:"Show metadata (0 bytes)"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:a.showSmallFiles,onChange:t=>P({...a,showSmallFiles:t.target.checked}),className:"themed-checkbox"}),e.jsx("span",{className:"text-sm text-themed-secondary",children:"Show small files (< 1MB)"})]})]})]})]}),C.length!==l.length&&e.jsxs(T,{color:"blue",icon:e.jsx(B,{className:"w-5 h-5"}),children:["Showing ",C.length," of ",l.length," downloads",a.selectedService!=="all"&&` for ${a.selectedService}`]}),e.jsx("div",{children:a.itemsPerPage==="unlimited"&&k.length>100?e.jsx(ne,{items:k,height:window.innerHeight-250,itemHeight:120,renderItem:K}):e.jsx("div",{className:"space-y-3",children:k.map(t=>"downloads"in t?I(t):_(t))})}),a.itemsPerPage==="unlimited"&&k.length>500&&e.jsxs(T,{color:"yellow",icon:e.jsx(te,{className:"w-5 h-5"}),children:["Loading ",k.length," items. Performance optimized with virtual scrolling."]})]})};export{pe as default};
//# sourceMappingURL=DownloadsTab-DwUoH0Ng.js.map

import{r as c,u as K,j as e,e as T,p as q,U as Y,D as J,q as Q,b as X,s as ee,S as se,t as M,v as te,i as $,w as ae,m as ie}from"./react-vendor-DGr9LWon.js";import{u as ce}from"./index-B2aET8M8.js";import{C as L,f as k,a as B,b as le}from"./Card-BNk8Xjj9.js";import{A as re}from"./Alert-XuuEtZ24.js";import"./vendor-BmYUbuLR.js";import"./tanstack-CPlEqbpz.js";function ne({items:h,height:u,itemHeight:f,renderItem:j,overscan:g=5,className:o=""}){const n=c.useRef(null),N=K({count:h.length,getScrollElement:()=>n.current,estimateSize:()=>f,overscan:g});return e.jsx("div",{ref:n,className:`overflow-auto ${o}`,style:{height:`${u}px`},children:e.jsx("div",{style:{height:`${N.getTotalSize()}px`,width:"100%",position:"relative"},children:N.getVirtualItems().map(d=>e.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:`${d.size}px`,transform:`translateY(${d.start}px)`},children:j(h[d.index],d.index)},d.key))})})}const p={SERVICE_FILTER:"lancache_downloads_service",ITEMS_PER_PAGE:"lancache_downloads_items",GROUP_GAMES:"lancache_downloads_group",SHOW_METADATA:"lancache_downloads_metadata",SHOW_SMALL_FILES:"lancache_downloads_show_small"},z=({options:h,value:u,onChange:f,placeholder:j="Select option",className:g=""})=>{const[o,n]=c.useState(!1),N=h.find(l=>l.value===u),d=l=>{f(l),n(!1)};c.useEffect(()=>{const l=b=>{b.target.closest(".custom-dropdown")||n(!1)};if(o)return document.addEventListener("mousedown",l),()=>document.removeEventListener("mousedown",l)},[o]);const S=l=>{l.key==="Enter"||l.key===" "?(l.preventDefault(),n(!o)):l.key==="Escape"&&n(!1)};return e.jsxs("div",{className:`relative custom-dropdown ${g}`,children:[e.jsxs("button",{type:"button",onClick:()=>n(!o),onKeyDown:S,className:"w-full px-3 py-2 themed-input text-themed-primary text-left focus:outline-none hover:bg-themed-hover transition-colors flex items-center justify-between","aria-haspopup":"listbox","aria-expanded":o,children:[e.jsx("span",{className:"truncate",children:N?N.label:j}),e.jsx(ie,{size:16,className:`transition-transform ${o?"rotate-180":""}`})]}),o&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>n(!1)}),e.jsx("div",{className:"mobile-dropdown sm:right-0 themed-card",children:e.jsx("div",{className:"py-1",children:h.map(l=>e.jsx("button",{type:"button",onClick:()=>d(l.value),className:`w-full px-4 py-2 text-left text-sm hover:bg-themed-hover transition-colors ${l.value===u?"bg-themed-hover text-themed-accent":"text-themed-secondary"}`,children:l.label},l.value))})})]})]})},ue=()=>{const{latestDownloads:h,mockMode:u,updateMockDataCount:f,updateApiDownloadCount:j}=ce(),[g,o]=c.useState(null),[n,N]=c.useState(null),[d,S]=c.useState({}),[l,b]=c.useState(null),[E,I]=c.useState(!1),[i,H]=c.useState(()=>({showZeroBytes:localStorage.getItem(p.SHOW_METADATA)==="true",showSmallFiles:localStorage.getItem(p.SHOW_SMALL_FILES)!=="false",selectedService:localStorage.getItem(p.SERVICE_FILTER)||"all",itemsPerPage:(()=>{const s=localStorage.getItem(p.ITEMS_PER_PAGE);return s==="unlimited"?"unlimited":s?parseInt(s,10):20})(),groupGames:localStorage.getItem(p.GROUP_GAMES)==="true"})),y=c.useCallback(s=>{H(t=>({...t,...s}))},[]);c.useEffect(()=>{localStorage.setItem(p.SERVICE_FILTER,i.selectedService),localStorage.setItem(p.ITEMS_PER_PAGE,i.itemsPerPage.toString()),localStorage.setItem(p.GROUP_GAMES,i.groupGames.toString()),localStorage.setItem(p.SHOW_METADATA,i.showZeroBytes.toString()),localStorage.setItem(p.SHOW_SMALL_FILES,i.showSmallFiles.toString())},[i]),c.useEffect(()=>{const s=i.itemsPerPage==="unlimited"?100:i.itemsPerPage;u&&f?f(s):!u&&j&&j(s)},[i.itemsPerPage,u,f,j]);const _=c.useMemo(()=>{const s=new Set(h.map(t=>t.service.toLowerCase()));return Array.from(s).sort()},[h]),O=c.useMemo(()=>[{value:"all",label:"All Services"},..._.map(s=>({value:s,label:s.charAt(0).toUpperCase()+s.slice(1)}))],[_]),R=c.useMemo(()=>[{value:"20",label:"20 items"},{value:"50",label:"50 items"},{value:"100",label:"100 items"},{value:"200",label:"200 items"},{value:"unlimited",label:"Load All"}],[]),C=c.useMemo(()=>{let s=[...h];return i.showZeroBytes||(s=s.filter(t=>(t.totalBytes||0)>0)),i.showSmallFiles||(s=s.filter(t=>(t.totalBytes||0)===0||(t.totalBytes||0)>=1048576)),i.selectedService!=="all"&&(s=s.filter(t=>t.service.toLowerCase()===i.selectedService)),s},[h,i]),D=c.useMemo(()=>{if(!i.groupGames)return null;const s={};return C.forEach(t=>{let a,r,m;t.gameName&&t.gameName!=="Unknown Steam Game"?(a=`game-${t.gameName}`,r=t.gameName,m="game"):(t.totalBytes||0)===0?(a=`metadata-${t.service}`,r=`${t.service} Metadata`,m="metadata"):(a=`content-${t.service}`,r=`${t.service} Content`,m="content"),s[a]||(s[a]={id:a,name:r,type:m,service:t.service,downloads:[],totalBytes:0,cacheHitBytes:0,cacheMissBytes:0,clientsSet:new Set,firstSeen:t.startTime,lastSeen:t.endTime||t.startTime,count:0,clientCount:0}),s[a].downloads.push(t),s[a].totalBytes+=t.totalBytes||0,s[a].cacheHitBytes+=t.cacheHitBytes||0,s[a].cacheMissBytes+=t.cacheMissBytes||0,s[a].clientsSet.add(t.clientIp),s[a].count++,new Date(t.startTime)<new Date(s[a].firstSeen)&&(s[a].firstSeen=t.startTime),t.endTime&&new Date(t.endTime)>new Date(s[a].lastSeen)&&(s[a].lastSeen=t.endTime)}),Object.values(s).map(t=>({...t,clientCount:t.clientsSet.size})).sort((t,a)=>a.totalBytes-t.totalBytes)},[C,i.groupGames]),v=c.useMemo(()=>{const s=i.groupGames?D:C;if(!s)return[];if(i.itemsPerPage==="unlimited")return s;const t=typeof i.itemsPerPage=="number"?i.itemsPerPage:50;return s.slice(0,t)},[i.groupGames,i.itemsPerPage,D,C]),F=s=>{const t=s.totalBytes||0,a=s.service.charAt(0).toUpperCase()+s.service.slice(1);return t===0?{type:"metadata",label:s.clientIp==="127.0.0.1"?`${a} Service`:"Metadata",icon:$}:s.service.toLowerCase()==="steam"&&s.gameName&&s.gameName!=="Unknown Steam Game"?{type:"game",label:s.gameName,icon:ae}:t<1048576?{type:"metadata",label:`${a} Update`,icon:$}:{type:"content",label:`${a} Content`,icon:M}},A=s=>s>=75?"progress-bar-high":s>=50?"progress-bar-medium":s>=25?"progress-bar-low":"progress-bar-critical",G=s=>"downloads"in s,U=async s=>{if(!(s.service.toLowerCase()!=="steam"||(s.totalBytes||0)===0||!s.id)&&(o(g===s.id?null:s.id),g!==s.id&&!d[s.id]))if(u)S(t=>({...t,[s.id]:{downloadId:s.id,service:"steam",appId:730,gameName:"Counter-Strike 2",gameType:"game",headerImage:"https://cdn.akamai.steamstatic.com/steam/apps/730/header.jpg",description:"Counter-Strike 2 is a tactical shooter.",totalBytes:s.totalBytes,cacheHitBytes:s.cacheHitBytes,cacheMissBytes:s.cacheMissBytes,cacheHitPercent:s.cacheHitPercent}}));else try{b(s.id);const t=await fetch(`/api/gameinfo/download/${s.id}`);if(t.ok){const a=await t.json();S(r=>({...r,[s.id]:a}))}}catch(t){console.error("Error fetching game info:",t)}finally{b(null)}},V=s=>{N(n===s?null:s)},P=c.useCallback(s=>{const t=n===s.id,a=s.totalBytes>0?s.cacheHitBytes/s.totalBytes*100:0;return e.jsxs(L,{padding:"md",children:[e.jsx("div",{onClick:()=>V(s.id),className:"cursor-pointer",children:e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsxs("div",{className:"col-span-12 sm:col-span-4 md:col-span-3",children:[e.jsx("p",{className:"text-xs text-themed-muted",children:"Group"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{size:16,className:`transition-transform ${t?"rotate-90":""}`}),e.jsx("div",{className:"w-6 h-6 rounded bg-themed-secondary flex items-center justify-center",children:e.jsx(q,{size:14,className:"text-themed-accent"})}),e.jsx("span",{className:"text-sm font-medium text-themed-accent",children:s.name})]}),e.jsxs("p",{className:"text-xs text-themed-muted",children:[s.count," items"]})]}),e.jsxs("div",{className:"col-span-6 sm:col-span-4 md:col-span-3",children:[e.jsx("p",{className:"text-xs text-themed-muted",children:"Size"}),e.jsx("p",{className:"text-sm font-medium",children:s.totalBytes>0?k(s.totalBytes):"Metadata"})]}),e.jsxs("div",{className:"col-span-6 sm:col-span-4 md:col-span-3",children:[e.jsx("p",{className:"text-xs text-themed-muted",children:"Clients"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Y,{size:14}),e.jsx("span",{className:"text-sm",children:s.clientCount||0})]})]}),e.jsxs("div",{className:"col-span-12 md:col-span-3",children:[e.jsx("p",{className:"text-xs text-themed-muted",children:"Cache Hit"}),s.totalBytes>0?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 progress-track rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:`h-full ${A(a)}`,style:{width:`${a}%`}})}),e.jsx("span",{className:"text-sm",children:B(a)})]}):e.jsx("p",{className:"text-sm text-themed-muted",children:"N/A"})]})]})}),t&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-themed-secondary my-4"}),e.jsx("div",{className:"max-h-72 overflow-y-auto",children:e.jsx("div",{className:"space-y-2",children:s.downloads.map(r=>e.jsx("div",{className:"p-2 bg-themed-tertiary rounded",children:e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsx("span",{className:"text-xs",children:r.clientIp}),e.jsx("span",{className:"text-xs",children:k(r.totalBytes)}),e.jsx("span",{className:"text-xs",children:B(r.cacheHitPercent||0)}),e.jsx("span",{className:"text-xs",children:le(r.startTime)})]})},r.id))})})]})]},s.id)},[n]),w=c.useCallback(s=>{const t=g===s.id,a=s.service.toLowerCase()==="steam",r=(s.totalBytes||0)>0,m=F(s),Z=m.icon,x=s.id?d[s.id]:void 0;return e.jsx(L,{padding:"md",className:a&&r?"cursor-pointer":"",children:e.jsxs("div",{onClick:()=>a&&r?U(s):void 0,children:[e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsxs("div",{className:"col-span-12 sm:col-span-4 md:col-span-3",children:[e.jsx("p",{className:"text-xs text-themed-muted",children:"Service"}),e.jsxs("div",{className:"flex items-center gap-2",children:[a&&r&&e.jsx(T,{size:16,className:`transition-transform ${t?"rotate-90":""}`}),e.jsx("span",{className:`text-sm font-medium service-${s.service.toLowerCase()}`,children:s.service}),e.jsx("div",{className:`w-6 h-6 rounded flex items-center justify-center ${m.type==="game"?"download-game":m.type==="metadata"?"download-metadata":"download-content"}`,children:e.jsx(Z,{size:14,className:m.type==="game"?"text-themed-primary":m.type==="metadata"?"text-themed-muted":"text-themed-primary"})})]}),m.label&&e.jsx("p",{className:"text-xs text-themed-muted truncate",children:m.label})]}),e.jsxs("div",{className:"col-span-6 sm:col-span-4 md:col-span-2",children:[e.jsx("p",{className:"text-xs text-themed-muted",children:"Client"}),e.jsx("p",{className:"text-sm",children:s.clientIp})]}),e.jsxs("div",{className:"col-span-6 sm:col-span-4 md:col-span-2",children:[e.jsx("p",{className:"text-xs text-themed-muted",children:"Size"}),e.jsx("p",{className:`text-sm ${r?"font-medium":""}`,children:r?k(s.totalBytes):"Metadata"})]}),e.jsxs("div",{className:"col-span-12 sm:col-span-6 md:col-span-3",children:[e.jsx("p",{className:"text-xs text-themed-muted",children:"Cache Hit"}),r?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 progress-track rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:`h-full ${A(s.cacheHitPercent||0)}`,style:{width:`${s.cacheHitPercent||0}%`}})}),e.jsx("span",{className:"text-sm",children:B(s.cacheHitPercent||0)})]}):e.jsx("p",{className:"text-sm text-themed-muted",children:"N/A"})]}),e.jsxs("div",{className:"col-span-12 sm:col-span-6 md:col-span-2",children:[e.jsx("p",{className:"text-xs text-themed-muted",children:"Status"}),s.isActive?e.jsxs("span",{className:"status-active inline-flex items-center gap-1 px-2 py-1 text-xs rounded",children:[e.jsx(J,{size:12}),"Active"]}):e.jsxs("span",{className:"status-completed inline-flex items-center gap-1 px-2 py-1 text-xs rounded",children:[e.jsx(Q,{size:12}),"Done"]})]})]}),t&&x&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border-t border-themed-secondary my-4"}),l===s.id?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(X,{className:"w-6 h-6 animate-spin"})}):e.jsxs("div",{className:"flex gap-6 items-start",children:[x.headerImage&&e.jsx("div",{className:"flex-shrink-0",children:e.jsx("img",{src:x.headerImage,alt:x.gameName,className:"rounded w-56 object-cover shadow-lg",style:{height:"107px"}})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-lg font-semibold text-themed-primary mb-3 truncate",children:x.gameName}),x.description&&e.jsx("p",{className:"text-sm text-themed-muted mb-4 line-clamp-3",children:x.description.length>200?`${x.description.substring(0,200)}...`:x.description}),x.appId&&e.jsxs("a",{href:`https://store.steampowered.com/app/${x.appId}`,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 text-sm text-themed-accent hover:text-themed-primary transition-colors font-medium",children:["View on Steam ",e.jsx(ee,{size:16})]})]})]})]})]})},s.id)},[g,d,l]),W=c.useCallback(s=>G(s)?P(s):w(s),[P,w]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-0",children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-semibold text-themed-primary",children:"Downloads"}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{options:O,value:i.selectedService,onChange:s=>y({selectedService:s}),className:"flex-1 sm:min-w-[140px]"}),e.jsx(z,{options:R,value:i.itemsPerPage.toString(),onChange:s=>y({itemsPerPage:s==="unlimited"?"unlimited":parseInt(s)}),className:"flex-1 sm:min-w-[120px]"})]}),e.jsxs("div",{className:"relative flex-shrink-0 self-end sm:self-auto",children:[e.jsx("button",{onClick:()=>I(!E),className:"p-2.5 themed-button-primary transition-colors w-full sm:w-auto",children:e.jsx(se,{size:20})}),E&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>I(!1)}),e.jsx("div",{className:"mobile-dropdown sm:right-0 themed-card p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm font-medium",children:"Settings"}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:i.groupGames,onChange:s=>y({groupGames:s.target.checked}),className:"rounded border-themed-secondary"}),e.jsx("span",{className:"text-sm",children:"Group similar items"})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:i.showZeroBytes,onChange:s=>y({showZeroBytes:s.target.checked}),className:"rounded border-themed-secondary"}),e.jsx("span",{className:"text-sm",children:"Show 0-byte requests"})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:i.showSmallFiles,onChange:s=>y({showSmallFiles:s.target.checked}),className:"rounded border-themed-secondary"}),e.jsx("span",{className:"text-sm",children:"Show small files"})]})]})})]})]})]})]}),v.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-themed-tertiary flex items-center justify-center mb-4",children:e.jsx(M,{size:32,className:"text-themed-muted"})}),e.jsx("p",{className:"text-themed-muted",children:"No downloads found"})]}),v.length>0&&e.jsx(e.Fragment,{children:i.itemsPerPage==="unlimited"&&v.length>100?e.jsx(ne,{items:v,height:window.innerHeight-250,itemHeight:120,renderItem:W,overscan:3}):e.jsx("div",{className:"space-y-3 max-h-[calc(100vh-250px)] overflow-y-auto custom-scrollbar",children:v.map(s=>G(s)?P(s):w(s))})}),i.itemsPerPage==="unlimited"&&v.length>500&&e.jsxs(re,{color:"yellow",icon:e.jsx(te,{className:"w-5 h-5"}),children:["Loading ",v.length," items. Performance optimized with virtual scrolling."]})]})};export{ue as default};
//# sourceMappingURL=DownloadsTab-D9kbXAvS.js.map

version: '3.8'

services:
  lancache-manager:
    image: ghcr.io/regix1/lancache-manager:latest
    container_name: lancache-manager
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      # Data directory - stores database, API key, themes, and cached images
      - ./data:/data

      # LANCache log directory (read-only recommended)
      - /mnt/logs:/logs:ro

      # LANCache cache directory
      # Use :ro for read-only monitoring
      # Remove :ro to enable cache clearing, corruption removal, and game removal
      - /mnt/cache:/cache:ro

      # Docker socket for nginx log rotation (optional)
      # Allows signaling nginx to reopen logs after manipulation
      # Set NginxLogRotation__Enabled=false and remove this line to disable
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      #=== User/Group Settings ===#
      # PUID/PGID: User and group ID the application runs as after setup
      # Set these to match your NFS/host filesystem permissions
      - PUID=1000
      - PGID=1000

      # TZ: Timezone for log timestamps and display
      - TZ=America/Chicago

      # ASPNETCORE_URLS: Internal port binding (required, do not change)
      - ASPNETCORE_URLS=http://+:80

      #=== Path Settings ===#
      # Single datasource mode (default):
      # LanCache__LogPath: Path to the LANCache access log file
      - LanCache__LogPath=/logs/access.log

      # LanCache__CachePath: Path to the LANCache cache directory
      - LanCache__CachePath=/cache

      #=== Multiple Datasources (Optional) ===#
      # Configure multiple LANCache instances with separate log/cache directories.
      # When DataSources are configured, LogPath and CachePath above are ignored.
      # Uncomment and modify the examples below for multi-datasource support:
      #
      # - LanCache__DataSources__0__Name=Steam
      # - LanCache__DataSources__0__CachePath=/mnt/cache/steam
      # - LanCache__DataSources__0__LogPath=/mnt/logs/steam
      # - LanCache__DataSources__0__Enabled=true
      #
      # - LanCache__DataSources__1__Name=Epic
      # - LanCache__DataSources__1__CachePath=/mnt/cache/epic
      # - LanCache__DataSources__1__LogPath=/mnt/logs/epic
      # - LanCache__DataSources__1__Enabled=true

      #=== Security Settings ===#
      # Security__EnableAuthentication: Master switch for authentication
      # true = require API key for admin features (recommended)
      # false = disable ALL authentication (dev/testing only)
      - Security__EnableAuthentication=true

      # Security__MaxAdminDevices: Number of devices that can use the same API key
      - Security__MaxAdminDevices=3

      # Security__GuestSessionDurationHours: Initial default for guest session duration
      # Only used on first startup - can be changed in Management UI afterwards
      # - Security__GuestSessionDurationHours=6

      # Security__RequireAuthForMetrics: Require API key for /metrics endpoint
      # true = Prometheus/Grafana must use Bearer token authentication
      # false = /metrics endpoint is publicly accessible
      - Security__RequireAuthForMetrics=false

      #=== Nginx Log Rotation Settings ===#
      # NginxLogRotation__Enabled: Auto-signal nginx to reopen logs after manipulation
      # Prevents monolithic container from losing log file handle
      # Requires docker.sock volume mount
      - NginxLogRotation__Enabled=true

      # NginxLogRotation__ContainerName: Name of the LANCache container
      # Leave empty for auto-detection, or specify container name (e.g., "lancache")
      - NginxLogRotation__ContainerName=

      #=== Optimization Settings ===#
      # Optimizations__EnableGarbageCollectionManagement: Enable GC controls in UI
      # true = show memory management controls in Management page
      # false = use default .NET garbage collection (recommended for most users)
      # Enable this for low-memory systems or if memory usage climbs over time
      - Optimizations__EnableGarbageCollectionManagement=false

      #=== Cache Clearing Settings ===#
      # CacheClear__DeleteMode: Default mode for cache clearing on startup
      # Can be changed in Management UI during runtime (does not persist)
      # "preserve" = keep directory structure, only delete files (default, safer)
      # "full" = delete everything including directories (faster, more thorough)
      # - CacheClear__DeleteMode=preserve

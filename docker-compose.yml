version: '3.8'

services:
  lancache-manager:
    image: ghcr.io/regix1/lancache-manager:latest
    container_name: lancache-manager
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      # Required: Data directory for database, API key, themes, and cached images
      - ./data:/data

      # Required: LANCache log directory
      # Add :ro for read-only (recommended for monitoring-only setups)
      - /mnt/lancache/logs:/logs:ro

      # Required: LANCache cache directory
      # Add :ro for read-only monitoring
      # Remove :ro to enable cache clearing, corruption removal, and game removal
      - /mnt/lancache/cache:/cache:ro

      # Optional: Docker socket for nginx log rotation and Steam Prefill
      # Required for: signaling nginx to reopen logs, spawning prefill containers
      # Remove :ro if using Steam Prefill (needs read-write for container management)
      - /var/run/docker.sock:/var/run/docker.sock

    environment:
      #=========================================================================
      # USER/GROUP SETTINGS
      #=========================================================================

      # User ID the application runs as (match your filesystem permissions)
      # Common values: 33 (www-data on Debian/Ubuntu), 1000 (default user)
      - PUID=33

      # Group ID the application runs as
      - PGID=33

      # Timezone for log timestamps and display
      # See: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones
      - TZ=America/Chicago

      # Internal port binding (required, do not change)
      - ASPNETCORE_URLS=http://+:80

      #=========================================================================
      # PATH SETTINGS
      #=========================================================================

      # Path to LANCache access log file (inside the container)
      - LanCache__LogPath=/logs/access.log

      # Path to LANCache cache directory (inside the container)
      - LanCache__CachePath=/cache

      # Auto-detect datasources by scanning for matching subdirectories
      # Scans /cache and /logs for folders that exist in both locations
      # Example: /cache/steam + /logs/steam â†’ creates "Steam" datasource
      # - LanCache__AutoDiscoverDatasources=true

      #=========================================================================
      # SECURITY SETTINGS
      #=========================================================================

      # Master switch for authentication
      # true = require API key for admin features (recommended)
      # false = disable ALL authentication (development only)
      - Security__EnableAuthentication=true

      # Number of devices that can share the same API key simultaneously
      - Security__MaxAdminDevices=3

      # Default guest session duration in hours (configurable in UI after first run)
      # - Security__GuestSessionDurationHours=6

      # Require API key for Prometheus /metrics endpoint
      # true = Prometheus must use Bearer token authentication
      # false = /metrics endpoint is publicly accessible
      - Security__RequireAuthForMetrics=false

      # Require authentication to access Swagger API documentation
      # - Security__ProtectSwagger=true

      # Comma-separated list of allowed CORS origins (empty = allow all)
      # Example: http://localhost:3000,https://mysite.com
      # - Security__AllowedOrigins=

      #=========================================================================
      # NGINX LOG ROTATION
      #=========================================================================

      # Automatically signal nginx to reopen logs after manipulation
      # Prevents LANCache monolithic container from losing log file handle
      # Requires docker.sock volume mount
      - NginxLogRotation__Enabled=true

      # Name of the LANCache container (leave empty for auto-detection)
      # Auto-detection finds containers with "lancache" in the name
      - NginxLogRotation__ContainerName=

      # How often to check for log rotation needs (in hours)
      # - NginxLogRotation__ScheduleHours=24

      #=========================================================================
      # OPTIMIZATION SETTINGS
      #=========================================================================

      # Show memory management controls in Management page
      # Enable for low-memory systems or if memory usage climbs over time
      # Most users should leave this disabled
      - Optimizations__EnableGarbageCollectionManagement=false

      #=========================================================================
      # CACHE CLEARING
      #=========================================================================

      # Default mode for cache clearing operations
      # "preserve" = keep directory structure, only delete files (safer)
      # "full" = delete everything including directories (faster, more thorough)
      # Can be changed in Management UI during runtime
      # - CacheClear__DeleteMode=preserve

      #=========================================================================
      # STEAM PREFILL
      # Pre-download games to your cache before LAN parties
      # Powered by: https://github.com/tpill90/steam-lancache-prefill
      #=========================================================================

      # Docker image for per-user prefill containers
      # - Prefill__DockerImage=ghcr.io/regix1/steam-prefill-daemon:latest

      # Session timeout in minutes (inactive sessions get cleaned up)
      # - Prefill__SessionTimeoutMinutes=120

      # Base path for daemon session data (commands/responses)
      # Must be inside /data for Docker sibling container access
      # - Prefill__DaemonBasePath=/data/prefill-sessions

      # Host path that maps to /data in this container
      # Auto-detected from container mounts. Only set if auto-detection fails.
      # Example: If docker-compose.yml is at /srv/lancache/docker-compose.yml
      # and you have ./data:/data, set this to /srv/lancache/data
      # - Prefill__HostDataPath=/srv/lancache/data

      #=========================================================================
      # MULTIPLE DATASOURCES (Optional)
      # Configure multiple LANCache instances or outsourced services
      # When DataSources are configured, LogPath/CachePath above are ignored
      #=========================================================================

      # Example: Main LANCache + outsourced Steam on separate drive
      #
      # - LanCache__DataSources__0__Name=Default
      # - LanCache__DataSources__0__CachePath=/cache
      # - LanCache__DataSources__0__LogPath=/logs
      # - LanCache__DataSources__0__Enabled=true
      #
      # - LanCache__DataSources__1__Name=Steam
      # - LanCache__DataSources__1__CachePath=/steam-cache
      # - LanCache__DataSources__1__LogPath=/steam-logs
      # - LanCache__DataSources__1__Enabled=true
      #
      # With additional volume mounts:
      # - /mnt/steam-drive/cache:/steam-cache:ro
      # - /mnt/steam-drive/logs:/steam-logs:ro

version: '3.8'

services:
  lancache-manager:
    image: ghcr.io/regix1/lancache-manager:latest
    container_name: lancache-manager
    restart: unless-stopped
    # Container starts as root for entrypoint setup, then drops to PUID/PGID user
    user: root
    ports:
      - "8080:80"
    volumes:
      # Your data directory
      - ./data:/data

      # Your actual paths from CACHE_ROOT
      # NOTE: For cache deletion features (corruption removal, game removal, cache clearing),
      # remove :ro from /cache to allow write access. Keep :ro for read-only monitoring.
      - /mnt/logs:/logs:ro
      - /mnt/cache/cache:/cache:ro

      # Docker socket for nginx log rotation (allows container to run docker exec)
      # SECURITY NOTE: Mounting docker.sock gives this container access to Docker daemon.
      # This is needed to signal nginx in the monolithic container to reopen log files
      # after log manipulation. Mounted read-only (:ro) for minimal access.
      # To disable this feature, set NginxLogRotation__Enabled=false and remove this line.
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # User/Group ID for file ownership - the application runs as this user
      # Set these to match your NFS/host filesystem permissions
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
      - ASPNETCORE_URLS=http://+:80
      - LanCache__LogPath=/logs/access.log
      - LanCache__CachePath=/cache
      - LanCache__StartFromEndOfLog=true
      - LanCache__ProcessHistoricalLogs=false
      # Security Settings
      - Security__EnableAuthentication=true    # GLOBAL: Set to 'false' to disable ALL authentication (dev/testing only)
      - Security__MaxAdminDevices=3            # Maximum number of admin devices that can share the same API key
      - Security__RequireAuthForMetrics=false  # Set to 'true' to require API key for /metrics endpoint (Prometheus/Grafana access)
      # Optimization Settings
      - Optimizations__EnableGarbageCollectionManagement=false  # Set to 'true' to enable garbage collection optimization controls
      # Nginx Log Rotation Settings (prevents monolithic container from losing log access)
      - NginxLogRotation__Enabled=true          # Set to 'false' to disable automatic nginx log rotation
      - NginxLogRotation__ContainerName=        # Leave empty for auto-detection, or set to your monolithic container name
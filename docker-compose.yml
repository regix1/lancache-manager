version: '3.8'

services:
  lancache-manager:
    image: ghcr.io/regix1/lancache-manager:latest
    container_name: lancache-manager
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      # Required: Data directory for database, API key, themes, and cached images
      - ./data:/data

      # Required: LANCache log directory
      # Add :ro for read-only (recommended for monitoring-only setups)
      - /mnt/lancache/logs:/logs:ro

      # Required: LANCache cache directory
      # Add :ro for read-only monitoring
      # Remove :ro to enable cache clearing, corruption removal, and game removal
      - /mnt/lancache/cache:/cache:ro

      # Optional: Docker socket for nginx log rotation and Steam Prefill
      # Required for: signaling nginx to reopen logs, spawning prefill containers
      - /var/run/docker.sock:/var/run/docker.sock

    environment:
      #=========================================================================
      # REQUIRED - You must configure these for your environment
      #=========================================================================

      # User ID the application runs as (match your filesystem permissions)
      # Common values: 33 (www-data on Debian/Ubuntu), 1000 (default user)
      - PUID=33

      # Group ID the application runs as
      - PGID=33

      # Timezone for log timestamps and display
      # See: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones
      - TZ=America/Chicago

      # Path to LANCache access log file (inside the container)
      - LanCache__LogPath=/logs/access.log

      # Path to LANCache cache directory (inside the container)
      - LanCache__CachePath=/cache

      # Path to lancache .env file (for reading CACHE_DISK_SIZE when Docker socket unavailable)
      # If not set, auto-searches: /srv/lancache/.env, /opt/lancache/.env, /lancache/.env
      # - LanCache__EnvFilePath=/lancache/.env

      #=========================================================================
      # OPTIONAL - Defaults work for most users (auto-detected or sensible defaults)
      #=========================================================================

      # Internal port binding (do not change unless you know what you're doing)
      - ASPNETCORE_URLS=http://+:80

      #---------------------------------------------------------------------------
      # Security Settings
      #---------------------------------------------------------------------------

      # Master switch for authentication
      # true = require API key for admin features (recommended)
      # false = disable ALL authentication (development only)
      # - Security__EnableAuthentication=true

      # Number of devices that can share the same API key simultaneously
      # - Security__MaxAdminDevices=3

      # Default guest session duration in hours (configurable in UI after first run)
      # - Security__GuestSessionDurationHours=6

      # Require API key for Prometheus /metrics endpoint
      # true = Prometheus must use Bearer token authentication
      # false = /metrics endpoint is publicly accessible
      # - Security__RequireAuthForMetrics=false

      # Require authentication to access Swagger API documentation
      # - Security__ProtectSwagger=true

      # Comma-separated list of allowed CORS origins (empty = allow all)
      # Example: http://localhost:3000,https://mysite.com
      # - Security__AllowedOrigins=

      # Allowed file browser root paths (comma-separated)
      # Example: /data,/mnt
      # - Security__AllowedBrowsePaths=

      #---------------------------------------------------------------------------
      # API Options
      #---------------------------------------------------------------------------

      # Max number of clients returned in a single stats request
      # - ApiOptions__MaxClientsPerRequest=1000

      # Default limit for clients when no limit is provided
      # - ApiOptions__DefaultClientsLimit=100

      #---------------------------------------------------------------------------
      # Nginx Log Rotation (auto-detects LANCache container)
      #---------------------------------------------------------------------------

      # Automatically signal nginx to reopen logs after manipulation
      # Prevents LANCache monolithic container from losing log file handle
      # Requires docker.sock volume mount
      # - NginxLogRotation__Enabled=true

      # Name of the LANCache container (auto for auto-detection)
      # Auto-detection finds containers with "lancache" in the name
      # - NginxLogRotation__ContainerName=auto

      # How often to check for log rotation needs (in hours)
      # - NginxLogRotation__ScheduleHours=24

      #---------------------------------------------------------------------------
      # Optimization Settings
      #---------------------------------------------------------------------------

      # Show memory management controls in Management page
      # Enable for low-memory systems or if memory usage climbs over time
      # Most users should leave this disabled
      # - Optimizations__EnableGarbageCollectionManagement=false

      #---------------------------------------------------------------------------
      # Steam Prefill (auto-detects host paths from container mounts)
      # Pre-download games to your cache before LAN parties
      # Powered by: https://github.com/regix1/steam-prefill-daemon
      # (Fork of https://github.com/tpill90/steam-lancache-prefill)
      #---------------------------------------------------------------------------

      # Docker image for per-user prefill containers
      # - Prefill__DockerImage=ghcr.io/regix1/steam-prefill-daemon:latest

      # Session timeout in minutes (inactive sessions get cleaned up)
      # - Prefill__SessionTimeoutMinutes=120

      # Base path for daemon session data (commands/responses)
      # Must be inside /data for Docker sibling container access
      # - Prefill__DaemonBasePath=/data/prefill-sessions

      # Host path that maps to /data in this container (auto for auto-detection)
      # Auto-detected from container mounts. Only set if auto-detection fails.
      # Example: If docker-compose.yml is at /srv/lancache/docker-compose.yml
      # and you have ./data:/data, set this to /srv/lancache/data
      # - Prefill__HostDataPath=auto

      # Use TCP mode for prefill daemon communication
      # Options: true, false, or auto (auto = true on Windows, false on Linux)
      # - Prefill__UseTcp=auto

      # TCP port inside the prefill container
      # - Prefill__TcpPort=4379

      # TCP port exposed on the host for prefill containers
      # - Prefill__HostTcpPort=4379

      # TCP host used by the prefill daemon
      # - Prefill__TcpHost=127.0.0.1


      # Network configuration for prefill containers (AUTO-DETECTED)
      # The app auto-detects your lancache-dns setup:
      #   - If lancache-dns uses host networking → prefill uses host networking
      #   - If lancache-dns uses bridge → prefill uses its IP for DNS
      # Only set these if auto-detection fails or you have a custom setup.

      # Network mode for prefill containers
      # Options: "host", "bridge", a custom Docker network name, or "auto"
      # - Prefill__NetworkMode=auto

      # Explicit lancache-dns IP (auto for auto-detection)
      # Find with: docker inspect lancache-dns | grep IPAddress
      # - Prefill__LancacheDnsIp=auto

      #=========================================================================
      # ADVANCED - Multiple Datasources (Optional)
      # Configure multiple LANCache instances or outsourced services
      # When DataSources are configured, LogPath/CachePath above are ignored
      #=========================================================================

      # Example: Main LANCache + outsourced Steam on separate drive
      #
      # - LanCache__DataSources__0__Name=Default
      # - LanCache__DataSources__0__CachePath=/cache
      # - LanCache__DataSources__0__LogPath=/logs
      # - LanCache__DataSources__0__Enabled=true
      #
      # - LanCache__DataSources__1__Name=Steam
      # - LanCache__DataSources__1__CachePath=/steam-cache
      # - LanCache__DataSources__1__LogPath=/steam-logs
      # - LanCache__DataSources__1__Enabled=true
      #
      # With additional volume mounts:
      # - /mnt/steam-drive/cache:/steam-cache:ro
      # - /mnt/steam-drive/logs:/steam-logs:ro

      # Auto-detect datasources by scanning for matching subdirectories
      # Scans /cache and /logs for folders that exist in both locations
      # Example: /cache/steam + /logs/steam → creates "Steam" datasource
      # - LanCache__AutoDiscoverDatasources=true

      #=========================================================================
      # DEBUGGING - Enable verbose logging for troubleshooting
      #=========================================================================

      # Enable debug logging for platform-specific operations (path resolution,
      # file system detection, Docker communication, etc.)
      # Useful for diagnosing issues with volume mounts, permissions, or Docker socket
      # - Logging__LogLevel__LancacheManager.Infrastructure.Platform=Debug
